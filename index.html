<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livslinjen - En svensk resa</title>
    <style>
        /* ... (Behåll CSS från föregående svar, men jag lägger till några justeringar för tidslinjen här) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; 
            padding: 20px; 
            overflow-y: auto; 
        }
        .container { max-width: 1200px; width: 100%; margin: 20px auto; padding: 0 10px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.0em; }

        .game-screen { background: rgba(255, 255, 255, 0.97); border-radius: 15px; padding: 20px 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); margin-bottom: 20px; }
        .character-info, .decade-summary, .life-goal-selection { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 5px solid #007bff; }
        .character-info h3, .decade-summary h3, .life-goal-selection h3 { margin-top:0; margin-bottom: 15px; color: #0056b3; font-size: 1.3em; }
        
        .life-goal-selection label { display: block; margin-bottom: 10px; background-color: #fff; padding: 10px; border-radius: 5px; border: 1px solid #ddd; cursor: pointer; font-size:0.95em; }
        .life-goal-selection label:hover { background-color: #e9ecef; }
        .life-goal-selection input[type="radio"] { margin-right: 10px; }

        .character-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; margin-top: 15px; }
        .stat-item { background: white; padding: 8px 10px; border-radius: 8px; border: 1px solid #dee2e6; font-size: 0.85em; }
        .stat-item strong { color: #007bff; }

        .timeline-container { margin: 20px 0; padding: 15px; background-color: #f0f0f0; border-radius: 10px; }
        .timeline-container h3 { color: #333; margin-bottom: 5px; font-size: 1.2em;}
        .timeline-container p { font-size: 0.9em; margin-bottom: 8px;}

        .timeline-grid-container { 
            border: 1px solid #ccc; 
            padding: 5px; background-color: #e9ecef; 
            border-radius: 5px; 
            margin-bottom: 10px;
            overflow-x: auto; /* For many years/slots if needed */
        }
        .timeline-track {
            display: grid;
            grid-template-columns: repeat(10, 1fr); /* 10 years */
            gap: 3px;
            margin-bottom: 3px;
            min-height: 45px; /* Höjd för varje spår */
            border-bottom: 1px dashed #d0d0d0;
        }
        .timeline-track:last-child { border-bottom: none; }

        .timeline-year-cell {
            background-color: #fff;
            border: 1px solid #dcdcdc;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            color: #777;
            min-width: 50px; /* Ensure cells have some width */
            position: relative; /* For potential project overlay */
            cursor: pointer;
        }
        .timeline-year-cell:hover { background-color: #e3f2fd; }
        .timeline-year-cell.occupied {
            font-weight: bold;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 2px;
            cursor: default;
        }
        .timeline-year-cell.occupied:hover { /* No special hover if occupied by default */ }


        #currentProjectsDisplay { padding: 10px; background-color: #f9f9f9; border-radius: 5px; margin-top:10px; }
        #currentProjectsDisplay h4 {font-size: 1em; margin-bottom: 8px;}
        #currentProjectsDisplay p { margin: 5px 0; font-size: 0.9em; }
        #currentProjectsDisplay .project-entry { padding: 6px 8px; margin-bottom: 5px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.85em;}
        #currentProjectsDisplay .project-entry small { font-weight:normal; font-size:0.9em; display:block;}

        .project-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 15px; margin: 20px 0; }
        .project-category { background: white; border-radius: 10px; padding: 15px; border: 2px solid #dee2e6; transition: all 0.3s ease; }
        .project-category:hover { border-color: #007bff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .project-category h4 { margin-bottom: 10px; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 5px; font-size: 1.1em; }
        
        .project-item { background: #f8f9fa; padding: 10px 12px; margin: 8px 0; border-radius: 5px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; font-size: 0.9em; }
        .project-item strong { display: block; margin-bottom: 3px; font-size: 1.05em;}
        .project-item:hover { background: #e3f2fd; border-color: #007bff; }
        .project-item.disabled { background: #e9ecef; color: #6c757d; cursor: not-allowed; opacity: 0.7; }
        .project-item .details { display: block; font-size: 0.8em; color: #555; margin-top: 4px; line-height: 1.3; }
        .project-item .costs, .project-item .benefits { font-size: 0.75em; color: #444; }

        .historical-events, .random-event-display { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 15px; margin: 20px 0; }
        .historical-events h3, .random-event-display h3 { color: #856404; margin-bottom: 10px; font-size: 1.2em; }
        .historical-events ul, .random-event-display ul { list-style-position: inside; padding-left: 0; font-size:0.9em; }
        .historical-events li, .random-event-display li { margin-bottom: 5px; }
        .random-event-display p { margin-bottom: 5px; }

        .controls { display: flex; gap: 15px; margin: 25px 0 10px 0; justify-content: center; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.95em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-primary { background: linear-gradient(45deg, #007bff, #0056b3); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: linear-gradient(45deg, #dc3545, #c82333); color: white; }
        .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(220,53,69,0.3); }

        .decade-header { text-align: center; background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .decade-header h2 { font-size: 1.6em; margin-bottom: 3px; }
        .decade-header p { font-size: 0.9em; }

        .reflection-screen { background: #f8f9fa; border-radius: 15px; padding: 25px 30px; margin: 20px 0; }
        .reflection-screen h2, .summary-screen h2 { text-align: center; color: #0056b3; margin-bottom: 20px; font-size: 1.5em; }
        
        .life-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 20px 0; }
        .summary-card { background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #007bff; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .summary-card h4 { color: #007bff; margin-bottom: 10px; font-size: 1.15em; }
        .summary-card ul { list-style-type: none; padding-left: 0; font-size: 0.9em; }
        .summary-card li { margin-bottom: 8px; }
        .summary-card li ul { margin-left: 15px; margin-top: 5px; }
        .summary-card li ul li { font-size: 0.95em; margin-bottom: 4px; }
        .summary-card p { font-size: 0.9em; line-height: 1.5; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 15px; }
        .modal-content { background: white; padding: 25px; border-radius: 15px; max-width: 480px; width: 100%; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-content h3 { color: #007bff; margin-bottom: 15px; font-size: 1.3em; }
        .modal-content p { margin-bottom: 15px; line-height: 1.6; font-size: 0.95em; }
        .modal-content .effects { font-size: 0.85em; color: #555; margin-top:10px; padding-top:10px; border-top: 1px solid #eee; text-align:left;}

        .intro-screen { text-align: left; padding: 20px 25px; }
        .intro-screen h2 { color: #007bff; margin-bottom: 20px; text-align: center; font-size: 1.6em; }
        .intro-screen h3 { color: #0056b3; margin-top: 18px; margin-bottom: 8px; font-size: 1.2em;}
        .intro-screen p, .intro-screen li { font-size: 0.95em; line-height: 1.6; margin-bottom: 8px; color: #333; }
        .intro-screen ul { list-style-position: inside; margin-left: 5px; margin-bottom:12px; }
        .intro-screen ul ul { margin-left: 20px; margin-top: 5px;}
        .intro-screen strong { color: #0056b3; }

        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 0px; }
            .game-screen { padding: 15px; }
            .header h1 { font-size: 1.8em; }
            .project-menu { grid-template-columns: 1fr; }
            .character-stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🇸🇪 livslinjen - en svensk resa</h1>
            <p>ett sociologiskt simulationsspel om att växa upp i sverige 1960-2020</p>
        </div>

        <div id="gameArea" class="game-screen">
            <div id="introScreen" class="intro-screen">
                <h2>välkommen till livslinjen!</h2>
                <p>du är på väg att forma ett liv genom sex decennier i sverige, från 1960-talet till 2010-talet. dina val kommer att påverkas av samhällsförändringar, din bakgrund och dina personliga strävanden.</p>
                
                <h3>så här fungerar spelet:</h3>
                <ul>
                    <li><strong>karaktär:</strong> i början slumpas din karaktärs kön, födelseort och sociala bakgrund, vilket ger dig olika startförutsättningar. du får också välja ett övergripande livsmål.</li>
                    <li><strong>decennier:</strong> spelet är indelat i decennier (10-årsperioder). för varje decennium åldras din karaktär och du ställs inför nya val. historiska händelser specifika för decenniet presenteras och kan påverka ditt liv.</li>
                    <li><strong>kapitalformer (resurser):</strong> dina val och möjligheter styrs av olika kapitalformer som du både investerar och bygger upp:
                        <ul>
                            <li><strong>ekonomiskt kapital:</strong> pengar. investeras i projekt, boende etc. tjänas främst genom arbete.</li>
                            <li><strong>kulturellt kapital:</strong> kunskap, utbildning, färdigheter. investeras i genom utbildning, ger tillgång till vissa yrken och sociala sammanhang.</li>
                            <li><strong>socialt kapital:</strong> nätverk, vänner, familj. byggs genom relationer, ger stöd och öppnar dörrar.</li>
                            <li><strong>symboliskt kapital:</strong> status, anseende. fås genom karriär, utbildning och samhällsengagemang.</li>
                            <li><strong>ansträngningstid:</strong> varje decennium har du 100 enheter "ansträngning" att fördela på projekt. detta är skilt från projektens "varaktighet" i år.</li>
                        </ul>
                    </li>
                    <li><strong>projekt & tidslinje:</strong> inom varje decennium väljer du projekt inom livets domäner: <strong>utbildning, arbete, familj, fritid,</strong> och <strong>kulturellt engagemang</strong>.
                        <ul>
                            <li>varje projekt har en <strong>varaktighet</strong> (1-10 år) som upptar plats på din 10-åriga tidslinje för decenniet. du kan ha flera projekt parallellt om de får plats i olika "spår" på tidslinjen och du har tillräckligt med ansträngningstid.</li>
                            <li>projekt har en <strong>kostnad</strong> (investering) i form av ansträngningstid och ofta andra kapital.</li>
                            <li>projekt ger en <strong>avkastning</strong> i form av ökat kapital, förbättrad hälsa/lycka, eller nya möjligheter.</li>
                        </ul>
                    </li>
                    <li><strong>hälsa & lycka:</strong> dessa två mätare (0-100) speglar ditt välbefinnande och påverkas av dina val, projekt och slumpmässiga händelser.</li>
                    <li><strong>slumpmässiga händelser:</strong> livet är oförutsägbart! positiva och negativa händelser kan inträffa och påverka dina resurser och möjligheter (t.ex. ett arv ökar ekonomiskt kapital, sjukdom minskar hälsa och möjlighet att arbeta).</li>
                </ul>
                <p><strong>mål & reflektion:</strong> spelets syfte är att låta dig utforska hur olika liv kan formas av både personliga val och samhälleliga strukturer. det finns inga "rätta" eller "fel" vägar. kom ihåg att detta är en förenklad modell – verkliga livet är oändligt mycket rikare och mer komplext. använd gärna spelet som en grund för reflektion. lycka till!</p>
                <div class="controls">
                    <button class="btn btn-primary" onclick="showCharacterCreation()">börja din resa</button>
                </div>
            </div>

            <div id="characterScreen" style="display: none;">
                <h2>din karaktär genereras...</h2>
                <div id="characterInfo" class="character-info"></div>
                <div id="lifeGoalSelection" class="life-goal-selection">
                    <h3>välj ditt övergripande livsmål:</h3>
                    <label><input type="radio" name="lifeGoal" value="happiness" checked> maximal lycka: fokusera på välbefinnande och positiva upplevelser.</label>
                    <label><input type="radio" name="lifeGoal" value="wealth"> ekonomisk framgång: sträva efter rikedom och materiell trygghet.</label>
                    <label><input type="radio" name="lifeGoal" value="family"> stark familj: prioritera nära relationer och familjeliv.</label>
                    <label><input type="radio" name="lifeGoal" value="knowledge"> kulturell rikedom: sök kunskap, utbildning och kulturella erfarenheter.</label>
                    <label><input type="radio" name="lifeGoal" value="status"> högt anseende: arbeta för status, erkännande och inflytande.</label>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="confirmCharacterAndGoal()">fortsätt till första decenniet</button>
                </div>
            </div>
            
            <div id="gameplayScreen" style="display: none;">
                <div id="decadeHeader" class="decade-header"></div>
                <div id="characterDisplay" class="character-info"></div>
                
                <div id="randomEventModal" class="modal">
                    <div class="modal-content">
                        <h3 id="randomEventTitle"></h3>
                        <p id="randomEventDescription"></p>
                        <div id="randomEventEffects" class="effects"></div>
                        <button class="btn btn-primary" onclick="closeModal('randomEventModal')">ok</button>
                    </div>
                </div>

                <div id="historicalEventsDisplay" class="historical-events"></div>
                
                <div class="timeline-container">
                    <h3>din planering för detta decennium (10 år)</h3>
                    <p>ansträngningstid använd: <span id="effortTimeSpent">0</span> / <span id="totalEffortTimePerDecade">100</span> enheter.</p>
                    <div class="timeline-grid-container" id="timelineGridContainer">
                        </div>
                    <div id="currentProjectsDisplay">
                        <h4>valda projekt:</h4>
                        <p><em>inga projekt valda än. klicka på ett projekt nedan och sedan på en ledig startplats i tidslinjen.</em></p>
                    </div>
                </div>
                
                <div class="project-menu" id="projectMenu"></div>
                
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearCurrentDecadeProjects()">rensa valda projekt</button>
                    <button class="btn btn-primary" onclick="completeDecade()">slutför decennium</button>
                </div>
            </div>

            <div id="reflectionScreen" style="display: none;" class="reflection-screen">
                <h2>reflektion över ditt decennium</h2>
                <div id="reflectionContent" class="decade-summary"></div>
                <div id="decadeEvents" class="random-event-display" style="display:none;"><h3>händelser detta decennium:</h3><ul></ul></div>
                <div class="controls">
                    <button class="btn btn-primary" id="nextDecadeButton" onclick="nextDecade()">nästa decennium</button>
                </div>
            </div>

            <div id="summaryScreen" style="display: none;" class="reflection-screen">
                <h2>din livsresa - sammanfattning</h2>
                <div id="lifeSummary" class="life-summary"></div>
                 <div id="finalStats" class="character-info"></div>
                 <div id="lifeGoalReflection" class="decade-summary" style="margin-top:20px;"></div>
                 <div class="summary-card" style="margin-top:20px;">
                    <h4>en sista reflektion</h4>
                    <p>detta var en möjlig livsresa, formad av dina val, din bakgrund och en portion slump. verkligheten är oändligt mycket mer komplex och nyanserad, fylld av djupare relationer, fler valmöjligheter och händelser vi inte kan förutse.</p>
                    <p>vi hoppas att denna simulerade resa har gett upphov till tankar kring hur olika liv formas och vilka faktorer som spelar in – både de vi kan påverka och de som ligger utanför vår kontroll. vad tar du med dig från din karaktärs livslinje?</p>
                 </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="restartGame()">spela igen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {};
        const INITIAL_EFFORT_TIME_PER_DECADE = 100;
        const YEARS_PER_DECADE = 10;
        const TIMELINE_TRACKS = 3; // Antal parallella spår i tidslinjen

        let selectedProjectForPlacement = null; // Håller det projekt som väntar på att placeras

        function getDefaultGameState() {
            const initialTimeline = [];
            for (let i = 0; i < TIMELINE_TRACKS; i++) {
                initialTimeline.push(new Array(YEARS_PER_DECADE).fill(null));
            }
            return {
                character: null,
                currentDecadeIndex: 0,
                decades: ['1960-tal', '1970-tal', '1980-tal', '1990-tal', '2000-tal', '2010-tal'],
                age: 10, 
                currentDecadeTimeline: initialTimeline, // [track][year] = {projectId, projectName, color}
                currentDecadeSelectedProjects: [], // Lista över {project, track, startYear}
                allCompletedProjects: [], 
                completedUniqueProjectIds: new Set(),
                capital: { economic: 0, cultural: 0, social: 0, symbolic: 0, time: INITIAL_EFFORT_TIME_PER_DECADE },
                stats: { health: 80, happiness: 60 },
                constraints: { education_level: 'grundskola', hasJob: false, isMarried: false, hasFamily: false, hasChildren: false, currentHousing: 'hos föräldrar/motsv.' },
                decadeLog: [] 
            };
        }

        // Life Goals, Cities, Social Classes, Historical Events Data (behåll från föregående svar)
        const lifeGoalsData = {
            happiness: { name: "maximal lycka", description: "fokusera på välbefinnande och positiva upplevelser.", bonus_info: "Ger bonus till lyckopoäng från projekt och händelser." },
            wealth: { name: "ekonomisk framgång", description: "sträva efter rikedom och materiell trygghet.", bonus_info: "Ger bonus till ekonomiskt kapital från projekt och händelser." },
            family: { name: "stark familj", description: "prioritera nära relationer och familjeliv.", bonus_info: "Ger bonus till socialt kapital relaterat till familj och relationer." },
            knowledge: { name: "kulturell rikedom", description: "sök kunskap, utbildning och kulturella erfarenheter.", bonus_info: "Ger bonus till kulturellt kapital från utbildning och kulturprojekt." },
            status: { name: "högt anseende", description: "arbeta för status, erkännande och inflytande.", bonus_info: "Ger bonus till symboliskt kapital från karriär och engagemang." }
        };
        const swedishCities = [ /* ... Samma som förut ... */ ];
        const socialClasses = [ /* ... Samma som förut ... */ ];
        const historicalEventsData = { /* ... Samma som förut, men se till att texter är på svenska och gemener ... */
             0: { title: 'folkhemmets expansion och ungdomskultur (1960-tal)', events: ['stark ekonomisk tillväxt...', 'utbildningsreformer...'], modifiers: { capital_growth: { cultural: 0.05 }, general_optimism: 0.05} },
             1: { title: 'progg, oljekris och jämställdhetsdebatt (1970-tal)', events: ['oljekrisen leder till ekonomisk osäkerhet...', 'miljörörelsen...'], modifiers: { capital_change: { economic: -0.05, social: 0.05 }, job_security_increase: 0.05 } },
             2: { title: 'yuppies, it-revolutionens början (1980-tal)', events: ['finansmarknaden avregleras...', 'datorer och tidig it...'], modifiers: { capital_growth: { economic: 0.1, symbolic: 0.05}, tech_opportunities: 0.05} },
             3: { title: 'ekonomisk kris, eu-inträde och internet (1990-tal)', events: ['fastighets- och finanskris...', 'sverige går med i eu...'], modifiers: { capital_change: { economic: -0.1 }, unemployment_risk: 0.1, tech_bubble_effect: 0.05 } },
             4: { title: 'globalisering och it-krasch (2000-tal)', events: ['it-bubblan spricker...', 'terrorattackerna 11 september...'], modifiers: { capital_volatility: { economic: 0.05 }, cultural_capital_value_increase: 0.05 } },
             5: { title: 'sociala medier och klimatfokus (2010-tal)', events: ['sociala medier blir en dominerande kraft...', 'klimatförändringarna...'], modifiers: { capital_change: { social: (gs) => gs.character.lifeGoal === 'family' ? 0.03 : -0.03 }, tech_impact_social: 0.1 } }
        };


        // PROJECT DATA & CATEGORIES (omarbetad för att passa nya domäner och mekanik)
        // Kostnader: cost.time är ansträngningstid. cost.economic är pengar.
        // Fördelar (benefits): capital: {}, stats: {}
        const projectData = {
            // UTBILDNING
            edu_grundskola_avslutad: { id: 'edu_grundskola_avslutad', name: "avsluta grundskolan", category: "utbildning", duration: 0, costs: { time: 0 }, requirements: { age_min: 15}, benefits: { capital: { cultural: 10 } }, outcomes: { education_level: "grundskola avslutad" }, description: "grundläggande obligatorisk utbildning.", unique: true, auto_assign_age: 15 },
            edu_gymnasium: { id: 'edu_gymnasium', name: 'gymnasieutbildning', category: "utbildning", duration: 3, costs: { time: 35, economic: 10 }, requirements: { age_min: 15, age_max: 22, education_level: "grundskola avslutad" }, benefits: { capital: { cultural: 35, social: 5, symbolic: 5 }, stats: { happiness: 5 } }, outcomes: { education_level: 'gymnasium' }, description: 'högskoleförberedande eller yrkesinriktad utbildning (3 år).', unique: true },
            edu_universitet_grund: { id: 'edu_universitet_grund', name: 'universitetsstudier (kandidat)', category: "utbildning", duration: 3, costs: { time: 45, economic: 40 }, requirements: { age_min: 18, education_level: 'gymnasium', capital_min: {cultural: 30} }, benefits: { capital: { cultural: 50, social: 10, symbolic: 15 }, stats: { happiness: 5 } }, outcomes: { education_level: 'högskola kandidat' }, description: 'grundläggande akademisk examen, t.ex. kandidatexamen (3 år).', unique: true },
            edu_universitet_avancerad: { id: 'edu_universitet_avancerad', name: 'universitetsstudier (master)', category: "utbildning", duration: 2, costs: { time: 40, economic: 30 }, requirements: { age_min: 20, education_level: 'högskola kandidat', capital_min: {cultural: 60} }, benefits: { capital: { cultural: 35, symbolic: 20 }, stats: { happiness: 5 } }, outcomes: { education_level: 'högskola master' }, description: 'fördjupade akademiska studier (2 år).', unique: true },
            edu_yrkeshogskola: { id: 'edu_yrkeshogskola', name: 'yrkeshögskola', category: "utbildning", duration: 2, costs: { time: 30, economic: 20 }, requirements: { age_min: 18, education_level: ['gymnasium', 'grundskola avslutad'] }, benefits: { capital: { cultural: 25, social: 5, symbolic: 5 }, stats: { career_prospects: 15 } }, outcomes: { education_level: 'yrkeshögskola' }, description: 'praktisk, yrkesinriktad högre utbildning (2 år).', unique: true },
            edu_folkhogskola: { id: 'edu_folkhogskola', name: 'folkhögskola (kurs)', category: "utbildning", duration: 1, costs: { time: 20, economic: 10 }, requirements: { age_min: 18 }, benefits: { capital: { cultural: 20, social: 10 }, stats: { happiness: 10 } }, outcomes: { education_level: 'folkhögskola' }, description: 'bildning och personlig utveckling, kan ge behörighet (1 år).' },

            // ARBETE
            work_extrajobb: { id: 'work_extrajobb', name: 'extrajobb/deltidsjobb', category: "arbete", duration: 1, costs: { time: 15 }, requirements: { age_min: 15 }, benefits: { capital: { economic: 25, social: 5 } }, outcomes: {}, description: 'tjäna extra pengar vid sidan av studier eller annat (flexibel varaktighet, här 1 år).' }, // Duration 1, ansträngning per år
            work_enkelt_heltid: { id: 'work_enkelt_heltid', name: 'enklare heltidsarbete', category: "arbete", duration: 5, costs: { time: 50, health: -5 }, requirements: { age_min: 18, education_level: ['grundskola avslutad', 'gymnasium', 'folkhögskola'] }, benefits: { capital: { economic: 150, social: 5 } }, outcomes: { constraints: { hasJob: true } }, description: 'stabilt men kanske slitsamt arbete (5 år).' },
            work_kvalificerat: { id: 'work_kvalificerat', name: 'kvalificerat arbete', category: "arbete", duration: 8, costs: { time: 60 }, requirements: { age_min: 22, education_level: ['gymnasium', 'yrkeshögskola', 'högskola kandidat'] }, benefits: { capital: { economic: 250, symbolic: 10, social: 10 } }, outcomes: { constraints: { hasJob: true } }, description: 'anställning som kräver utbildning/erfarenhet (8 år).' },
            work_specialist_chef: { id: 'work_specialist_chef', name: 'specialist-/chefsposition', category: "arbete", duration: 10, costs: { time: 70, social: -5, health: -10 }, requirements: { age_min: 30, education_level: ['högskola kandidat', 'högskola master'], capital_min: {cultural: 70, social: 40, symbolic: 20} }, benefits: { capital: { economic: 400, symbolic: 30 }, stats: { happiness: -5 } }, outcomes: { constraints: { hasJob: true } }, description: 'ansvarsfullt och välbetalt, men krävande (10 år).' },
            work_eget_foretag: { id: 'work_eget_foretag', name: 'starta eget företag', category: "arbete", duration: 6, costs: { time: 75, economic: 100, social: -10, health: -10 }, requirements: { age_min: 25, capital_min:{ economic: 80, cultural: 30 } }, benefits: { capital: { economic: 300, symbolic: 25 }, stats: { happiness: 10 } }, outcomes: { constraints: { hasJob: true } }, description: 'riskfyllt men med chans till stor frihet och förtjänst (6 år).' },
            
            // FAMILJ
            family_partner: { id: 'family_partner', name: 'skaffa fast partner', category: "familj", duration: 1, costs: { time: 20, economic: 10 }, requirements: { age_min: 18, capital_min: { social: 20 } }, benefits: { stats: { happiness: 20, health: 5 }, capital: { social: 25 } }, outcomes: { constraints: { hasFamily: true } }, description: 'inled en seriös och varaktig relation (1 år).' },
            family_sambo_gifta: { id: 'family_sambo_gifta', name: 'bli sambo/gifta sig', category: "familj", duration: 0, costs: { time: 10, economic: 40 }, requirements: { age_min: 20, constraints_is: { hasFamily: true } }, benefits: { stats: { happiness: 15 }, capital: { social: 10, symbolic: 10 } }, outcomes: { constraints: { isMarried: true, currentHousing: "delad bostad" } }, description: 'formalisera förhållandet. (engångshändelse)', unique:true },
            family_barn: { id: 'family_barn', name: 'skaffa barn', category: "familj", duration: 5, costs: { time: 50, economic: 100, happiness: -15, health: -5 }, requirements: { age_min: 22, age_max: 45, constraints_is: { hasFamily: true } }, benefits: { stats: { happiness: 45 }, capital: { social: 30, symbolic: 5 } }, outcomes: { constraints: { hasChildren: true } }, description: 'utöka familjen. en stor omställning och glädje (tar ca 5 år av intensivt fokus).' }, 
            family_boende_hyresratt: { id: 'family_boende_hyresratt', name: 'flytta till hyresrätt', category: "familj", duration: 0, costs: { time:5, economic: 30 }, requirements: { age_min: 18 }, benefits: { stats: { happiness: 5 } }, outcomes: { constraints: { currentHousing: "hyresrätt" } }, description: 'skaffa eget (eller första gemensamma) boende.'},
            family_boende_bostadsratt: { id: 'family_boende_bostadsratt', name: 'köpa bostadsrätt', category: "familj", duration: 0, costs: { time:10, economic: 180 }, requirements: { age_min: 23, constraints_is: {hasJob: true}, capital_min: {economic: 100} }, benefits: { capital: { economic: 20, symbolic: 15 }, stats: { happiness: 10 } }, outcomes: { constraints: { currentHousing: "bostadsrätt" } }, description: 'investera i ett ägt hem.', unique: true},
            family_boende_villa: { id: 'family_boende_villa', name: 'köpa villa/radhus', category: "familj", duration: 0, costs: { time: 15, economic: 300 }, requirements: { age_min: 28, constraints_is: {hasJob: true, hasFamily: true}, capital_min: {economic: 200} }, benefits: { capital: { economic: 40, symbolic: 25 }, stats: { happiness: 15 } }, outcomes: { constraints: { currentHousing: "villa/radhus" } }, description: 'det stora familjeboendet.', unique: true},

            // FRITID
            fritid_traning_regelbunden: { id: 'fritid_traning_regelbunden', name: 'regelbunden träning', category: "fritid", duration: 1, costs: { time: 10, economic: 10 }, requirements: {}, benefits: { stats: { health: 15, happiness: 5 } }, description: 'håll dig aktiv (kontinuerlig, här 1 år).' }, // Kan väljas flera gånger
            fritid_hobby_intensiv: { id: 'fritid_hobby_intensiv', name: 'intensiv hobbyverksamhet', category: "fritid", duration: 2, costs: { time: 15, economic: 20 }, requirements: {}, benefits: { stats: { happiness: 15 }, capital: { cultural: 10, social: 5 } }, description: 'odla ett djupt intresse, t.ex. musik, konst, idrott (2 år).' },
            fritid_resa_stor: { id: 'fritid_resa_stor', name: 'stor resa utomlands', category: "fritid", duration: 0, costs: { time: 10, economic: 100 }, requirements: { capital_min:{ economic: 80 } }, benefits: { stats: { happiness: 25 }, capital: { cultural: 15 } }, description: 'upptäck världen, en längre resa (ca 1-2 månader).' },
            fritid_personlig_utveckling: { id: 'fritid_personlig_utveckling', name: 'kurs i personlig utveckling', category: "fritid", duration: 0, costs: { time: 10, economic: 50 }, requirements: {}, benefits: { stats: { happiness: 15, health: 5 }, capital: {cultural: 5} }, description: 'investera i dig själv (mindfulness, terapi etc.).' },
            fritid_vanner: { id: 'fritid_vanner', name: 'underhålla vänskapsrelationer', category: "fritid", duration: 0, costs: { time: 15, economic: 10 }, requirements: {}, benefits: { stats: { happiness: 15 }, capital: { social: 20 } }, description: 'aktivt umgås med vänner (kontinuerlig ansträngning).'},

            // KULTURELLT ENGAGEMANG
            kultur_forening: { id: 'kultur_forening', name: 'engagemang i förening', category: "kulturellt engagemang", duration: 2, costs: { time: 15, economic: 5 }, requirements: {}, benefits: { capital: { social: 15, cultural: 5, symbolic: 5 }, stats: { happiness: 10 } }, description: 'delta aktivt i en idrotts-, kultur- eller intresseförening (2 år).' },
            kultur_politik_lokal: { id: 'kultur_politik_lokal', name: 'politiskt engagemang (lokalt)', category: "kulturellt engagemang", duration: 3, costs: { time: 20 }, requirements: { capital_min: { cultural: 20 } }, benefits: { capital: { social: 10, symbolic: 15, cultural: 5 }, stats: { happiness: 5 } }, description: 'bli aktiv i ett politiskt parti eller en intresseorganisation (3 år).' },
            kultur_volontar: { id: 'kultur_volontar', name: 'volontärarbete', category: "kulturellt engagemang", duration: 1, costs: { time: 15 }, requirements: {}, benefits: { capital: { social: 15, symbolic: 5 }, stats: { happiness: 15 } }, description: 'gör en ideell insats för ett gott ändamål (1 år).' },
            kultur_konsumtion_regelbunden: { id: 'kultur_konsumtion_regelbunden', name: 'regelbunden kulturkonsumtion', category: "kulturellt engagemang", duration: 0, costs: { time: 10, economic: 20 }, requirements: {}, benefits: { capital: { cultural: 15 }, stats: { happiness: 10 } }, description: 'besök ofta teatrar, konserter, museer, läs böcker.' },
        };
        
        const projectCategories = {
            "utbildning": { color: '#007bff', projects: [] },
            "arbete": { color: '#28a745', projects: [] },
            "familj": { color: '#dc3545', projects: [] },
            "fritid": { color: '#6f42c1', projects: [] },
            "kulturellt engagemang": { color: '#20c997', projects: [] }
        };

        for (const projectId in projectData) {
            const project = projectData[projectId];
            if (projectCategories[project.category]) {
                projectCategories[project.category].projects.push(project);
            }
        }

        const randomEventTypes = { /* ... Samma som förut, men texter på svenska och effekter som tydligt ändrar kapital ... */
             positive: [
                { title: 'oväntat arv', description: 'en avlägsen släkting har testamenterat en summa pengar till dig.', effects_display: "+100 ekonomiskt kapital, +10 lycka", effects: { capital: { economic: 100 }, stats: { happiness: 10 } }, probability: 0.04, class_modifier: { 'överklass': 1.8, 'arbetarklass': 0.7 } },
                { title: 'vinst på trisslott', description: 'plötsligt händer det! en mindre summa pengar.', effects_display: "+30 ekonomiskt kapital, +5 lycka", effects: { capital: { economic: 30 }, stats: { happiness: 5 } }, probability: 0.05 },
                // ... fler positiva händelser
            ],
            negative: [
                { title: 'långvarig sjukdom', description: 'du drabbas av en sjukdom som påverkar dig under en längre tid.', effects_display: "-20 hälsa, -15 lycka, -30 ekonomiskt kapital, -15 ansträngningstid", effects: { stats: { health: -20, happiness: -15 }, capital: { economic: -30, time: -15 } }, probability: 0.05 },
                { title: 'arbetslöshet', description: 'företaget skär ner och du blir tyvärr uppsagd.', effects_display: "-50 ekonomiskt kapital, -20 lycka, jobbstatus: nej", effects: { capital: { economic: -50 }, stats: { happiness: -20 }, outcomes: { constraints: { hasJob: false } } }, probability: 0.04, requirements: { constraints_is: { hasJob: true } } },
                // ... fler negativa händelser
            ],
            neutral: [ /* ... */ ]
        };
        
        // --- UI HELPER FUNCTIONS --- (i stort sett samma som förut)
        function showScreen(screenId) {
            ['introScreen', 'characterScreen', 'gameplayScreen', 'reflectionScreen', 'summaryScreen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            if (document.getElementById(screenId)) {
                document.getElementById(screenId).style.display = 'block';
            }
        }
        
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        function showModal(modalId, title, description, effectsText = "") {
            document.getElementById(modalId).style.display = 'flex';
            if (title) document.getElementById(modalId.replace('Modal', 'Title')).innerText = title;
            if (description) document.getElementById(modalId.replace('Modal', 'Description')).innerText = description;
            const effectsDiv = document.getElementById(modalId.replace('Modal', 'Effects'));
            if (effectsDiv) {
                effectsDiv.innerHTML = effectsText ? `<strong>effekter:</strong><br>${effectsText.replace(/\n/g, "<br>")}` : "";
                effectsDiv.style.display = effectsText ? 'block' : 'none';
            }
        }


        // --- CHARACTER CREATION --- (i stort sett samma som förut)
        function weightedRandom(items) { /* ... */ return items[items.length-1];} // Förenklad för korthet
        function showCharacterCreation() {
            gameState = getDefaultGameState(); 
            const gender = Math.random() < 0.5 ? 'kvinna' : 'man';
            const birthplace = weightedRandom(swedishCities);
            const socialClass = weightedRandom(socialClasses);

            gameState.character = {
                gender: gender,
                birthplace: birthplace.name,
                socialClass: socialClass.name,
                region: birthplace.region,
                opportunitiesModifier: socialClass.opportunitiesModifier,
                classDetails: socialClass,
                lifeGoal: null 
            };

            Object.assign(gameState.capital, socialClass.initialCapital);
            gameState.capital.time = INITIAL_EFFORT_TIME_PER_DECADE;

            const infoDiv = document.getElementById('characterInfo');
            infoDiv.innerHTML = `
                <h3>din start i livet (ålder: ${gameState.age}):</h3>
                <p><strong>kön:</strong> ${gameState.character.gender}</p>
                <p><strong>födelseort:</strong> ${gameState.character.birthplace} (${gameState.character.region})</p>
                <p><strong>social bakgrund:</strong> ${gameState.character.socialClass} (möjlighetsmod.: ${gameState.character.opportunitiesModifier.toFixed(2)})</p>
                <div class="character-stats">
                    <div class="stat-item"><strong>ekonomiskt:</strong> ${gameState.capital.economic}</div>
                    <div class="stat-item"><strong>kulturellt:</strong> ${gameState.capital.cultural}</div>
                    <div class="stat-item"><strong>socialt:</strong> ${gameState.capital.social}</div>
                    <div class="stat-item"><strong>symboliskt:</strong> ${gameState.capital.symbolic}</div>
                </div>`;
            showScreen('characterScreen');
        }
         function confirmCharacterAndGoal() { /* ... Samma som förut ... */ 
            const selectedGoal = document.querySelector('input[name="lifeGoal"]:checked');
            gameState.character.lifeGoal = selectedGoal ? selectedGoal.value : 'happiness';
            startFirstDecade();
        }


        // --- GAME FLOW ---
        function restartGame() { showScreen('introScreen'); }

        function startFirstDecade() {
            gameState.currentDecadeIndex = 0;
            const grundskola = projectData.edu_grundskola_avslutad;
            if (gameState.age >= grundskola.requirements.age_min && !gameState.completedUniqueProjectIds.has(grundskola.id)) {
                 gameState.decadeLog[0] = { projects: [], events: [] }; // Initialize log for decade 0
                applyProjectDirectly(grundskola, gameState.decadeLog[0]);
            }
            setupDecade();
        }
        
        function setupDecade() {
            gameState.age += (gameState.currentDecadeIndex === 0 && gameState.age === 10) ? 0 : 10; // Start at 10, then +10
            gameState.capital.time = INITIAL_EFFORT_TIME_PER_DECADE; 
            
            // Reset timeline and selected projects for the new decade
            gameState.currentDecadeTimeline = [];
            for (let i = 0; i < TIMELINE_TRACKS; i++) {
                gameState.currentDecadeTimeline.push(new Array(YEARS_PER_DECADE).fill(null));
            }
            gameState.currentDecadeSelectedProjects = [];

            if (!gameState.decadeLog[gameState.currentDecadeIndex]) {
                 gameState.decadeLog[gameState.currentDecadeIndex] = { projects: [], events: [] };
            }

            document.getElementById('decadeHeader').innerHTML = `
                <h2>${gameState.decades[gameState.currentDecadeIndex]} (ålder: ${gameState.age}-${gameState.age+9})</h2>
                <p>planera dina kommande 10 år. ditt livsmål: ${lifeGoalsData[gameState.character.lifeGoal]?.name || 'inget valt'}</p>`;
            
            updateUIDisplays();
            renderHistoricalEvents();
            renderProjects();
            renderTimelineGrid(); 
            
            triggerRandomEvents();
            showScreen('gameplayScreen');
        }

        function nextDecade() { /* ... Samma som förut ... */ 
            gameState.currentDecadeIndex++;
            if (gameState.currentDecadeIndex < gameState.decades.length) setupDecade();
            else showFinalSummary();
        }
        
        function updateUIDisplays() { // Samlingsfunktion för UI-uppdateringar
            updateCharacterDisplay();
            updateCurrentProjectsListDisplay();
            renderTimelineGrid(); // Uppdatera även tidslinjegridden visuellt
        }

        function updateCharacterDisplay() {
            const displayDiv = document.getElementById('characterDisplay');
            let capHTML = '<div class="character-stats">';
            for (const [key, value] of Object.entries(gameState.capital)) { capHTML += `<div class="stat-item"><strong>${key}:</strong> ${Math.round(value)}</div>`; }
            capHTML += '</div>';

            let statsHTML = '<div class="character-stats" style="margin-top:10px;">';
            for (const [key, value] of Object.entries(gameState.stats)) { statsHTML += `<div class="stat-item"><strong>${key}:</strong> ${Math.round(value)}</div>`; }
            statsHTML += '</div>';

            let constrHTML = '<div style="margin-top:10px; font-size:0.85em;"><strong>nuvarande status:</strong> ';
            constrHTML += `utbildning: ${gameState.constraints.education_level.replace("_", " ")}, `;
            constrHTML += `jobb: ${gameState.constraints.hasJob ? 'ja' : 'nej'}, `;
            constrHTML += `gift/sambo: ${gameState.constraints.isMarried ? 'ja' : 'nej'}, `;
            constrHTML += `barn: ${gameState.constraints.hasChildren ? 'ja' : 'nej'}, `;
            constrHTML += `boende: ${gameState.constraints.currentHousing}`;
            constrHTML += '</div>';

            displayDiv.innerHTML = `
                <h3>din status (ålder: ${gameState.age})</h3>
                <p><strong>klass:</strong> ${gameState.character.socialClass}, <strong>kön:</strong> ${gameState.character.gender}</p>
                <h4>kapital:</h4>${capHTML}<h4>livskvalitet:</h4>${statsHTML}${constrHTML}`;
            
            const totalEffortTimeSpent = gameState.currentDecadeSelectedProjects.reduce((sum, pInfo) => sum + getAdjustedProjectCost(pInfo.project, 'time'), 0);
            document.getElementById('effortTimeSpent').innerText = totalEffortTimeSpent;
            document.getElementById('totalEffortTimePerDecade').innerText = INITIAL_EFFORT_TIME_PER_DECADE;
        }
        function renderHistoricalEvents() { /* ... Samma som förut ... */ }

        // --- TIMELINE & PROJECT HANDLING ---
        function renderTimelineGrid() {
            const container = document.getElementById('timelineGridContainer');
            container.innerHTML = ''; 

            for (let trackIndex = 0; trackIndex < TIMELINE_TRACKS; trackIndex++) {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'timeline-track';
                trackDiv.dataset.track = trackIndex;

                for (let yearIndex = 0; yearIndex < YEARS_PER_DECADE; yearIndex++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'timeline-year-cell';
                    cellDiv.dataset.year = yearIndex;
                    cellDiv.dataset.track = trackIndex;
                    
                    const projectInCell = gameState.currentDecadeTimeline[trackIndex][yearIndex];
                    if (projectInCell) {
                        cellDiv.classList.add('occupied');
                        cellDiv.style.backgroundColor = projectInCell.color || '#aabbcc';
                        cellDiv.textContent = projectInCell.projectName.substring(0,6) + ".."; // Kort namn
                        cellDiv.title = projectInCell.projectName;
                    } else {
                        cellDiv.textContent = `år ${yearIndex + 1}`;
                        cellDiv.onclick = () => handleTimelineCellClick(trackIndex, yearIndex);
                    }
                    trackDiv.appendChild(cellDiv);
                }
                container.appendChild(trackDiv);
            }
        }

        function handleTimelineCellClick(trackIndex, yearIndex) {
            if (!selectedProjectForPlacement) {
                showModal('randomEventModal', 'inget projekt valt', 'välj först ett projekt från listan nedan innan du placerar det på tidslinjen.');
                return;
            }

            const project = selectedProjectForPlacement;
            const duration = project.duration === 0 ? 1 : project.duration; // Projekt med duration 0 tar 1 år på tidslinjen

            // Kontrollera om projektet får plats
            if (yearIndex + duration > YEARS_PER_DECADE) {
                showModal('randomEventModal', 'projektet får inte plats', `detta projekt (${duration} år) får inte plats med start från år ${yearIndex + 1} på detta spår.`);
                return;
            }

            // Kontrollera om spåret är ledigt för hela perioden
            for (let i = 0; i < duration; i++) {
                if (gameState.currentDecadeTimeline[trackIndex][yearIndex + i]) {
                    showModal('randomEventModal', 'plats upptagen', `en del av perioden (år ${yearIndex + 1} - ${yearIndex + duration}) på spår ${trackIndex + 1} är redan upptagen.`);
                    return;
                }
            }
            
            // Kontrollera resurser (igen, för säkerhets skull)
            const actualEffortTimeCost = getAdjustedProjectCost(project, 'time');
            const actualEconomicCost = getAdjustedProjectCost(project, 'economic');
            const totalEffortTimeSpent = gameState.currentDecadeSelectedProjects.reduce((sum, pInfo) => sum + getAdjustedProjectCost(pInfo.project, 'time'), 0);

            if ((totalEffortTimeSpent + actualEffortTimeCost) > INITIAL_EFFORT_TIME_PER_DECADE) {
                 showModal('randomEventModal', 'för lite ansträngningstid', 'du har inte tillräckligt med ansträngningstid kvar för detta projekt.');
                return;
            }
             if (gameState.capital.economic < (actualEconomicCost > 0 ? actualEconomicCost : 0)) {
                 showModal('randomEventModal', 'för lite pengar', 'du har inte råd med detta projekt.');
                return;
            }


            // Placera projektet
            for (let i = 0; i < duration; i++) {
                gameState.currentDecadeTimeline[trackIndex][yearIndex + i] = {
                    projectId: project.id,
                    projectName: project.name,
                    color: projectCategories[project.category]?.color || '#ccc'
                };
            }

            // Dra av ekonomisk kostnad direkt
             if (actualEconomicCost !== 0) { gameState.capital.economic -= actualEconomicCost; }


            gameState.currentDecadeSelectedProjects.push({ project, track: trackIndex, startYear: yearIndex });
            selectedProjectForPlacement = null; // Återställ valt projekt
            
            updateUIDisplays(); // Uppdaterar allt inkl. tidslinjen och projektlistan
            renderProjects(); // För att gråa ut projekt som inte längre kan väljas
        }
        
        function meetsRequirements(project) { /* ... Samma som förut, men med getAdjustedProjectCost i åtanke ... */ 
            if (project.unique && gameState.completedUniqueProjectIds.has(project.id)) return false;
            if (project.requirements.age_min && gameState.age < project.requirements.age_min) return false;
            if (project.requirements.age_max && gameState.age > project.requirements.age_max) return false;
            if (project.requirements.capital_min) {
                for (const cap_type in project.requirements.capital_min) {
                    if ((gameState.capital[cap_type]||0) < project.requirements.capital_min[cap_type]) return false;
                }
            }
            if (project.requirements.education_level) {
                const currentLevel = gameState.constraints.education_level;
                const reqLevels = Array.isArray(project.requirements.education_level) ? project.requirements.education_level : [project.requirements.education_level];
                const eduH = ['ingen', 'grundskola', 'grundskola avslutad', 'folkhögskola', 'gymnasium', 'yrkeshögskola', 'högskola kandidat', 'högskola master'];
                let currentIdx = eduH.indexOf(currentLevel);
                let meetsEdu = reqLevels.some(rl => eduH.indexOf(rl) <= currentIdx);
                if (!meetsEdu) return false;
            }
            if (project.requirements.constraints_is) {
                for (const key in project.requirements.constraints_is) {
                    if (gameState.constraints[key] !== project.requirements.constraints_is[key]) return false;
                }
            }
            return true;
        }
        
        function getAdjustedProjectCost(project, costType) { /* ... Samma som förut ... */ 
             let baseCost = project.costs[costType] || 0;
             // Lägg till logik för blocked_by_if och reduced_by_if om de ska påverka kostnader (ej implementerat fullt ut här för korthet)
            return Math.round(baseCost);
        }

        function renderProjects() {
            const menuDiv = document.getElementById('projectMenu');
            menuDiv.innerHTML = '';
            const totalEffortTimeSpent = gameState.currentDecadeSelectedProjects.reduce((sum, pInfo) => sum + getAdjustedProjectCost(pInfo.project, 'time'), 0);

            for (const categoryName in projectCategories) {
                const category = projectCategories[categoryName];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'project-category';
                categoryDiv.innerHTML = `<h4>${categoryName}</h4>`;

                category.projects.forEach(project => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'project-item';
                    
                    const actualEffortTimeCost = getAdjustedProjectCost(project, 'time');
                    const actualEconomicCost = getAdjustedProjectCost(project, 'economic');
                    const duration = project.duration === 0 ? 1 : project.duration; // Minst 1 år på tidslinjen om duration=0

                    let costText = `anstr: ${actualEffortTimeCost}`;
                    if (actualEconomicCost !== 0) costText += `, eko: ${actualEconomicCost}`;
                    
                    itemDiv.innerHTML = `<strong>${project.name}</strong> (${duration} år)<span class="details">${project.description}</span><span class="costs">kostnad: ${costText}</span>`;
                    
                    const canAffordEffortTime = (totalEffortTimeSpent + actualEffortTimeCost) <= INITIAL_EFFORT_TIME_PER_DECADE;
                    const canAffordEconomic = gameState.capital.economic >= (actualEconomicCost > 0 ? actualEconomicCost : 0) ;
                    
                    if (meetsRequirements(project) && canAffordEffortTime && canAffordEconomic) {
                        itemDiv.onclick = () => {
                            selectedProjectForPlacement = project;
                            // Kanske markera projektet visuellt som "valt för placering"
                            showModal('randomEventModal', 'placera projekt', `du har valt "${project.name}". klicka nu på en ledig startplats i tidslinjen (i ett av spåren ovan) för att placera ut det.`);
                        };
                    } else {
                        itemDiv.classList.add('disabled');
                        // ... (samma logik för itemDiv.title som förut)
                    }
                    categoryDiv.appendChild(itemDiv);
                });
                menuDiv.appendChild(categoryDiv);
            }
        }
        
        // selectProject blir nu ersatt av att klicka på projekt i menyn (sätter selectedProjectForPlacement)
        // och sedan klicka på tidslinjen (handleTimelineCellClick).

        function updateCurrentProjectsListDisplay() { 
            const display = document.getElementById('currentProjectsDisplay');
            if (gameState.currentDecadeSelectedProjects.length === 0) {
                display.innerHTML = '<p><em>inga projekt valda än. klicka på ett projekt nedan och sedan på en ledig startplats i tidslinjen.</em></p>';
                return;
            }
            display.innerHTML = '<h4>valda projekt detta decennium:</h4>';
            gameState.currentDecadeSelectedProjects.forEach(pInfo => {
                const p = pInfo.project;
                const pDiv = document.createElement('div');
                pDiv.classList.add('project-entry');
                pDiv.style.backgroundColor = projectCategories[p.category]?.color || '#ccc';
                let text = `${p.name}`;
                if (p.duration > 0) text += ` (${p.duration} år, spår ${pInfo.track + 1}, startår ${pInfo.startYear + 1})`;
                text += `<small>anstr: ${getAdjustedProjectCost(p, 'time')}${p.costs.economic ? ', eko: ' + getAdjustedProjectCost(p, 'economic') : ''}</small>`;
                pDiv.innerHTML = text;
                display.appendChild(pDiv);
            });
        }
        
        function clearCurrentDecadeProjects() {
            gameState.currentDecadeSelectedProjects.forEach(pInfo => {
                const actualEconomicCost = getAdjustedProjectCost(pInfo.project, 'economic');
                if (actualEconomicCost !== 0) { gameState.capital.economic += actualEconomicCost; } // Refund
            });

            gameState.currentDecadeSelectedProjects = [];
            // Reset timeline grid data
            gameState.currentDecadeTimeline = [];
            for (let i = 0; i < TIMELINE_TRACKS; i++) {
                gameState.currentDecadeTimeline.push(new Array(YEARS_PER_DECADE).fill(null));
            }
            selectedProjectForPlacement = null;
            updateUIDisplays();
            renderProjects();
        }
        
        function applyProjectDirectly(project, decadeLog) { // För t.ex. autotilldelad grundskola
            if(project.unique) gameState.completedUniqueProjectIds.add(project.id);
            gameState.allCompletedProjects.push({ name: project.name, decade: gameState.currentDecadeIndex === 0 ? -1 : gameState.currentDecadeIndex }); // -1 för förspel

            let effectSummary = [];
            // Apply benefits
            if (project.benefits) {
                if(project.benefits.capital) Object.keys(project.benefits.capital).forEach(cap => { gameState.capital[cap] += project.benefits.capital[cap]; effectSummary.push(`${cap}: +${project.benefits.capital[cap]}`); });
                if(project.benefits.stats) Object.keys(project.benefits.stats).forEach(stat => { gameState.stats[stat] += project.benefits.stats[stat]; effectSummary.push(`${stat}: +${project.benefits.stats[stat]}`); });
            }
            // Apply outcomes
            if (project.outcomes) {
                if(project.outcomes.constraints) Object.assign(gameState.constraints, project.outcomes.constraints);
                if(project.outcomes.education_level) gameState.constraints.education_level = project.outcomes.education_level;
                 effectSummary.push(`status ändrad`);
            }
            if (decadeLog) { // Check if decadeLog exists
                 decadeLog.projects.push({ name: project.name, effects: effectSummary.join(', ') });
            }
        }

        function applyProjectInvestmentAndReturn(project, currentDecadeLogEntry) {
            let investmentSummary = [];
            let returnSummary = [];
            let lifeGoal = gameState.character.lifeGoal;

            // Ansträngningstid är redan "spenderad" genom att projektet valts och finns i listan.
            // Ekonomisk kostnad drogs vid placering. Övriga direkta kostnader:
            if (project.costs) {
                for (const type in project.costs) {
                    if (type !== 'time' && type !== 'economic') { 
                        if (gameState.capital.hasOwnProperty(type)) {
                            gameState.capital[type] += project.costs[type]; 
                            if(project.costs[type] !== 0) investmentSummary.push(`${type}: ${project.costs[type]}`);
                        } else if (gameState.stats.hasOwnProperty(type)) {
                            gameState.stats[type] += project.costs[type];
                            if(project.costs[type] !== 0) investmentSummary.push(`${type}: ${project.costs[type]}`);
                        }
                    }
                }
            }
            
            // Avkastning (Benefits)
            if (project.benefits) {
                if (project.benefits.capital) {
                    for (const type in project.benefits.capital) {
                        let val = project.benefits.capital[type];
                        // Bonus från livsmål (exempel, behöver mer detaljerad data i lifeGoalsData)
                        if (lifeGoalsData[lifeGoal]?.bonus_rules?.capital_gain_multiplier?.[type]) {
                            val *= lifeGoalsData[lifeGoal].bonus_rules.capital_gain_multiplier[type];
                        }
                        gameState.capital[type] = (gameState.capital[type] || 0) + val;
                        returnSummary.push(`${type}: ${val >= 0 ? '+' : ''}${Math.round(val)}`);
                    }
                }
                if (project.benefits.stats) {
                    for (const type in project.benefits.stats) {
                        let val = project.benefits.stats[type];
                         if (lifeGoalsData[lifeGoal]?.bonus_rules?.stat_gain_multiplier?.[type]) {
                            val *= lifeGoalsData[lifeGoal].bonus_rules.stat_gain_multiplier[type];
                        }
                        gameState.stats[type] = (gameState.stats[type] || 0) + val;
                        returnSummary.push(`${type}: ${val >= 0 ? '+' : ''}${Math.round(val)}`);
                    }
                }
            }

            // Outcomes (statusförändringar)
            if (project.outcomes) {
                if (project.outcomes.constraints) {
                    Object.assign(gameState.constraints, project.outcomes.constraints);
                    Object.keys(project.outcomes.constraints).forEach(k => returnSummary.push(`ny status: ${k} -> ${project.outcomes.constraints[k]}`));
                }
                if (project.outcomes.education_level) {
                    const eduH = ['ingen', 'grundskola', 'grundskola avslutad', 'folkhögskola', 'gymnasium', 'yrkeshögskola', 'högskola kandidat', 'högskola master'];
                    if(eduH.indexOf(project.outcomes.education_level) > eduH.indexOf(gameState.constraints.education_level)){
                        gameState.constraints.education_level = project.outcomes.education_level;
                        returnSummary.push(`utbildning: ${project.outcomes.education_level.replace("_", " ")}`);
                    }
                }
            }

            if(project.unique) gameState.completedUniqueProjectIds.add(project.id);
            gameState.allCompletedProjects.push({ name: project.name, decade: gameState.currentDecadeIndex });
            
            let fullEffectString = "";
            if(investmentSummary.length > 0) fullEffectString += "investering: " + investmentSummary.join(', ') + ". ";
            if(returnSummary.length > 0) fullEffectString += "avkastning: " + returnSummary.join(', ') + ".";
            else if (investmentSummary.length === 0) fullEffectString = "ingen direkt kapitalpåverkan noterad.";


            currentDecadeLogEntry.projects.push({ name: project.name, effects: fullEffectString });
            return fullEffectString;
        }


        function completeDecade() {
            let reflectionHTML = `<h3>sammanfattning för ${gameState.decades[gameState.currentDecadeIndex]} (ålder ${gameState.age}-${gameState.age+9}):</h3>`;
            reflectionHTML += "<h4>genomförda projekt:</h4><ul>";
            
            const currentDecadeLogEntry = gameState.decadeLog[gameState.currentDecadeIndex];

            if (gameState.currentDecadeSelectedProjects.length === 0) {
                reflectionHTML += "<li>inga större projekt planerades detta decennium.</li>";
            }

            gameState.currentDecadeSelectedProjects.forEach(pInfo => {
                const project = pInfo.project;
                reflectionHTML += `<li><strong>${project.name}</strong>: `;
                const effectsString = applyProjectInvestmentAndReturn(project, currentDecadeLogEntry); // Använd den nya funktionen
                reflectionHTML += effectsString + "</li>";
            });
            reflectionHTML += "</ul>";

            // Historiska händelsers påverkan (samma som förut)
            // ...

            document.getElementById('reflectionContent').innerHTML = reflectionHTML;
            // ... (resten av completeDecade, som förut)
            const decadeEventsLog = currentDecadeLogEntry.events;
            const eventsListElement = document.querySelector("#decadeEvents ul");
            eventsListElement.innerHTML = ''; 
            if(decadeEventsLog && decadeEventsLog.length > 0){ /* ... */ } else { /* ... */ }

            gameState.stats.health = Math.max(0, Math.min(100, gameState.stats.health));
            gameState.stats.happiness = Math.max(0, Math.min(100, gameState.stats.happiness));

            document.getElementById('nextDecadeButton').innerText = (gameState.currentDecadeIndex >= gameState.decades.length -1) ? "se livssammanfattning" : "nästa decennium";
            showScreen('reflectionScreen');
        }
        
        // --- RANDOM EVENTS --- (Mestadels samma, men visa effekter tydligare i modal)
        function triggerRandomEvents() { /* ... */ }
        function applyRandomEventEffect(event) { 
            let effectSummary = [];
            let effectDisplayText = event.effects_display || ""; // Använd färdig text om den finns

            // Om effects_display inte finns, bygg den från effects-objektet
            if (!effectDisplayText && event.effects) {
                 if (event.effects.capital) {
                    for (const type in event.effects.capital) { effectSummary.push(`${type}: ${event.effects.capital[type] > 0 ? '+' : ''}${Math.round(event.effects.capital[type])}`); }
                }
                if (event.effects.stats) {
                    for (const type in event.effects.stats) { effectSummary.push(`${type}: ${event.effects.stats[type] > 0 ? '+' : ''}${Math.round(event.effects.stats[type])}`); }
                }
                if (event.effects.outcomes && event.effects.outcomes.constraints) {
                    for (const type in event.effects.outcomes.constraints) { effectSummary.push(`ny status: ${type} -> ${event.effects.outcomes.constraints[type]}`);}
                }
                effectDisplayText = effectSummary.join('\n');
            }
             // Applicera effekterna (samma logik som förut)
            if (event.effects.capital) { /* ... */ }
            if (event.effects.stats) { /* ... */ }
            if (event.effects.outcomes && event.effects.outcomes.constraints) { /* ... */ }
            
            // Logga händelsen
            if(!gameState.decadeLog[gameState.currentDecadeIndex]) gameState.decadeLog[gameState.currentDecadeIndex] = {projects: [], events: []};
            gameState.decadeLog[gameState.currentDecadeIndex].events.push({
                title: event.title,
                description: event.description,
                effects: effectDisplayText.replace(/\n/g, ", ") // För loggen
            });
            updateUIDisplays(); 
            // Visa modalen med den sammansatta effektexten
            showModal('randomEventModal', `slumpmässig händelse: ${event.title}`, event.description, effectDisplayText);
        }


        // --- FINAL SUMMARY --- (Mestadels samma som förut)
        function showFinalSummary() { /* ... */ }

        // Initial call
        showScreen('introScreen');

    </script>
</body>
</html>
