<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livsresan</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
         .header p {
            font-size: 1.1em;
        }

        .game-screen {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .character-info, .decade-summary {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
        }
        .character-info h3, .decade-summary h3 {
            margin-bottom: 10px;
            color: #0056b3;
        }

        .character-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 0.9em;
        }
        .stat-item strong {
            color: #007bff;
        }

        .timeline-container {
            margin: 20px 0;
        }
        .timeline-container h3 {
             color: #333;
             margin-bottom: 10px;
        }


        .timeline {
            background: #e9ecef;
            border-radius: 10px;
            padding: 20px;
            min-height: 150px; /* Adjusted */
            position: relative;
            overflow-x: auto;
        }
        
        #currentProjectsDisplay {
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        #currentProjectsDisplay p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #currentProjectsDisplay .project-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }


        .project-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .project-category {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .project-category:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .project-category h4 {
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .project-item {
            background: #f8f9fa;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-size: 0.9em;
        }
        .project-item:hover {
            background: #e3f2fd;
            border-color: #007bff;
        }
        .project-item.disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .project-item small {
            display: block;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
        }


        .historical-events, .random-event-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .historical-events h3, .random-event-display h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .historical-events ul, .random-event-display ul {
            list-style-position: inside;
            padding-left: 0;
        }
         .random-event-display p {
            margin-bottom: 5px;
        }


        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .btn-danger:hover {
             transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }


        .decade-header {
            text-align: center;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .decade-header h2 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .reflection-screen {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
         .reflection-screen h2, .summary-screen h2 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }

        .life-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .summary-card h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        .summary-card ul {
            list-style-type: none;
            padding-left: 0;
        }
        .summary-card li {
            margin-bottom: 5px;
            font-size: 0.95em;
        }


        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.8s ease;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            line-height: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.6;
        }


        .intro-screen {
            text-align: center;
            padding: 40px;
        }

        .intro-screen h2 {
            color: #007bff;
            margin-bottom: 20px;
        }

        .intro-screen p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
            color: #495057;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .project-menu {
                grid-template-columns: 1fr;
            }
            .character-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ‡¸ðŸ‡ª Livslinjen - En svensk resa</h1>
            <p>Ett sociologiskt simulationsspel om att vÃ¤xa upp i Sverige 1960-2020</p>
        </div>

        <div id="gameArea" class="game-screen">
            <div id="introScreen" class="intro-screen">
                <h2>VÃ¤lkommen till ditt liv</h2>
                <p>Du Ã¤r pÃ¥ vÃ¤g att fÃ¶lja en persons resa genom det moderna Sverige.</p>
                <p>FrÃ¥n 1960-talet till idag - hur pÃ¥verkar samhÃ¤llsfÃ¶rÃ¤ndringar, klass, kÃ¶n och geografi vÃ¥ra livsval?</p>
                <p>Varje decennium fÃ¥r du planera livsprojekt inom utbildning, arbete, relationer, boende och fritid.</p>
                <p><strong>Kom ihÃ¥g:</strong> Dina val pÃ¥verkas av bÃ¥de personliga Ã¶nskningar och strukturella fÃ¶rutsÃ¤ttningar. Dina kapitalformer (Ekonomiskt, Kulturellt, Socialt, Symboliskt och Tid) Ã¤r nyckeln till dina mÃ¶jligheter.</p>
                <button class="btn btn-primary" onclick="startGame()">BÃ¶rja din resa</button>
            </div>

            <div id="characterScreen" style="display: none;">
                <h2>Din karaktÃ¤r genereras...</h2>
                <div id="characterInfo" class="character-info"></div>
                <button class="btn btn-primary" onclick="startFirstDecade()">FortsÃ¤tt till fÃ¶rsta decenniet</button>
            </div>
            
            <div id="gameplayScreen" style="display: none;">
                <div id="decadeHeader" class="decade-header"></div>
                
                <div id="characterDisplay" class="character-info"></div>
                
                <div id="randomEventModal" class="modal">
                    <div class="modal-content">
                        <h3 id="randomEventTitle"></h3>
                        <p id="randomEventDescription"></p>
                        <button class="btn btn-primary" onclick="closeModal('randomEventModal')">Ok</button>
                    </div>
                </div>

                <div id="historicalEventsDisplay" class="historical-events"></div>
                
                <div class="timeline-container">
                    <h3>Din planering fÃ¶r detta decennium (10 Ã¥r)</h3>
                    <p>Total tid spenderad pÃ¥ projekt: <span id="timeSpent">0</span> / <span id="totalTimePerDecade">100</span> enheter.</p>
                    <div class="timeline">
                        <div id="currentProjectsDisplay">
                            <p><em>Inga projekt valda Ã¤n.</em></p>
                        </div>
                    </div>
                </div>
                
                <div class="project-menu" id="projectMenu"></div>
                
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearCurrentDecadeProjects()">Rensa valda projekt</button>
                    <button class="btn btn-primary" onclick="completeDecade()">SlutfÃ¶r decennium</button>
                </div>
            </div>

            <div id="reflectionScreen" style="display: none;" class="reflection-screen">
                <h2>Reflektion Ã¶ver ditt decennium</h2>
                <div id="reflectionContent" class="decade-summary"></div>
                <div id="decadeEvents" class="random-event-display" style="display:none;"><h3>HÃ¤ndelser detta decennium:</h3><ul></ul></div>
                <div class="controls">
                    <button class="btn btn-primary" id="nextDecadeButton" onclick="nextDecade()">NÃ¤sta decennium</button>
                </div>
            </div>

            <div id="summaryScreen" style="display: none;" class="reflection-screen">
                <h2>Din livsresa - Sammanfattning</h2>
                <div id="lifeSummary" class="life-summary"></div>
                 <div id="finalStats" class="character-info"></div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="restartGame()">Spela igen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {};
        const INITIAL_TIME_PER_DECADE = 100;

        function getDefaultGameState() {
            return {
                character: null,
                currentDecadeIndex: 0,
                decades: ['1960-tal', '1970-tal', '1980-tal', '1990-tal', '2000-tal', '2010-tal'],
                age: 10, // Startar vid 10 Ã¥rs Ã¥lder, fÃ¶rsta decenniet Ã¤r tonÃ¥ren/unga vuxna
                currentDecadeProjects: [], // Projekt valda fÃ¶r nuvarande decennium
                allCompletedProjects: [], // Alla projekt genomfÃ¶rda under spelets gÃ¥ng
                capital: {
                    economic: 100,  // Pengar
                    cultural: 20,   // Utbildning, kulturell kunskap
                    social: 20,     // NÃ¤tverk, vÃ¤nskap
                    symbolic: 10,   // Status, erkÃ¤nnande
                    time: INITIAL_TIME_PER_DECADE // Tid att spendera per decennium
                },
                stats: { // Mer som "livskvalitet"
                    health: 80,
                    happiness: 60
                },
                constraints: { // FÃ¶rutsÃ¤ttningar som pÃ¥verkar val
                    education_level: 'grundskola', // e.g., 'grundskola', 'gymnasium', 'hÃ¶gskola', 'yrkesutbildning'
                    hasJob: false,
                    isMarried: false,
                    hasFamily: false, // Generic family flag, could mean married or living with partner
                    hasChildren: false
                },
                decadeLog: [] // HÃ¥ller koll pÃ¥ hÃ¤ndelser per decennium
            };
        }


        const swedishCities = [
            { name: 'Stockholm', weight: 25, region: 'Storstadsregion' },
            { name: 'GÃ¶teborg', weight: 15, region: 'Storstadsregion' },
            { name: 'MalmÃ¶', weight: 10, region: 'Storstadsregion' },
            { name: 'Uppsala', weight: 5, region: 'Mellanstor stad' },
            { name: 'LinkÃ¶ping', weight: 4, region: 'Mellanstor stad' },
            { name: 'Ã–rebro', weight: 4, region: 'Mellanstor stad' },
            { name: 'VÃ¤sterÃ¥s', weight: 3, region: 'Mellanstor stad' },
            { name: 'NorrkÃ¶ping', weight: 3, region: 'Mellanstor stad' },
            { name: 'Helsingborg', weight: 3, region: 'Mellanstor stad' },
            { name: 'JÃ¶nkÃ¶ping', weight: 3, region: 'Mellanstor stad' },
            { name: 'SmÃ¥ort i SmÃ¥land', weight: 8, region: 'SmÃ¥ort' },
            { name: 'SmÃ¥ort i Dalarna', weight: 6, region: 'SmÃ¥ort' },
            { name: 'Glesbygd i Norrland', weight: 11, region: 'Glesbygd' }
        ];

        const socialClasses = [
            { name: 'Arbetarklass', weight: 45, initialCapital: { economic: 50, cultural: 15, social: 20, symbolic: 5 }, opportunitiesModifier: 0.8 },
            { name: 'Medelklass', weight: 40, initialCapital: { economic: 150, cultural: 30, social: 30, symbolic: 15 }, opportunitiesModifier: 1.0 },
            { name: 'Ã–verklass', weight: 15, initialCapital: { economic: 350, cultural: 45, social: 40, symbolic: 30 }, opportunitiesModifier: 1.2 }
        ];
        
        const historicalEventsData = {
            0: { // 1960s
                title: '1960-talet - Folkhemmets guldÃ¥lder',
                events: [
                    'VÃ¤lfÃ¤rdsstaten expanderar kraftigt: Ã–kad tillgÃ¥ng till utbildning och vÃ¥rd.',
                    'AllmÃ¤n tillÃ¤ggspension (ATP) infÃ¶rs, tryggare Ã¥lderdom.',
                    'KÃ¶nsrollerna bÃ¶rjar ifrÃ¥gasÃ¤ttas, fler kvinnor ut pÃ¥ arbetsmarknaden.',
                    'Stark ekonomisk tillvÃ¤xt och nÃ¤stintill full sysselsÃ¤ttning.'
                ],
                modifiers: { economic_growth: 0.1, social_change: 0.05} // Liten positiv effekt pÃ¥ ekonomi
            },
            1: { // 1970s
                title: '1970-talet - FÃ¶rÃ¤ndringens decennium',
                events: [
                    'MiljÃ¶medvetenhet vÃ¤xer fram, kÃ¤rnkraftsdebatt.',
                    'Kvinnors rÃ¤ttigheter stÃ¤rks: fri abort, utbyggd barnomsorg.',
                    'Oljekrisen (1973) pÃ¥verkar ekonomin negativt.',
                    'FÃ¶reningsliv och kollektiv rÃ¶relser blomstrar.'
                ],
                modifiers: { economic_growth: -0.05, cultural_change: 0.1 } // Negativ ekonomisk, positiv kulturell
            },
            2: { // 1980s
                title: '1980-talet - Individualism och tillvÃ¤xt',
                events: [
                    'Avreglering av finansmarknaden, "yuppie-eran".',
                    'IT-revolutionen bÃ¶rjar ta form.',
                    'BostadsrÃ¤tter blir allt vanligare och dyrare.',
                    'Ã–kade klassklyftor bÃ¶rjar synas.'
                ],
                modifiers: { economic_growth: 0.15, symbolic_capital_focus: 0.1} // Starkare ekonomisk tillvÃ¤xt
            },
            3: { // 1990s
                title: '1990-talet - Kris och fÃ¶rnyelse',
                events: [
                    'Bankkrisen och djup lÃ¥gkonjunktur i bÃ¶rjan av decenniet.',
                    'Sverige gÃ¥r med i EU (1995).',
                    'Internet och mobiltelefoni revolutionerar kommunikation.',
                    'HÃ¶g arbetslÃ¶shet och stora omstruktureringar i arbetslivet.'
                ],
                modifiers: { economic_growth: -0.1, job_security: -0.15 } // Stor ekonomisk nedgÃ¥ng initialt
            },
            4: { // 2000s
                title: '2000-talet - Globalisering och digitalisering',
                events: [
                    'Ã–kad invandring och ett mer mÃ¥ngkulturellt Sverige.',
                    'Bostadspriserna stiger kraftigt, Ã¶kad skuldsÃ¤ttning.',
                    'Digitaliseringen av samhÃ¤llet accelererar (bredband, sociala medier).',
                    'KlimatfrÃ¥gan blir alltmer central i debatten.'
                ],
                modifiers: { cultural_capital_value: 0.1, economic_volatility: 0.05 }
            },
            5: { // 2010s
                title: '2010-talet - Digital revolution och nya utmaningar',
                events: [
                    'Sociala medier formar opinion och kommunikation.',
                    'Flyktingkrisen (2015) och dess samhÃ¤llseffekter.',
                    'Politisk polarisering Ã¶kar.',
                    'Gig-ekonomi och nya, osÃ¤krare, arbetsformer vÃ¤xer fram.'
                ],
                modifiers: { social_capital_digital: 0.1, job_stability_change: -0.1 }
            }
        };
        
        const projectCategories = {
            'Utbildning': {
                color: '#007bff',
                projects: [
                    { id: 'edu1', name: 'Gymnasium', duration: 3, costs: { economic: 10, time: 30, cultural: -5 }, requirements: { age_min: 15 }, benefits: { cultural: 30, symbolic: 5 }, outcomes: { education_level: 'gymnasium' }, description: 'HÃ¶gskolefÃ¶rberedande eller yrkesinriktad utbildning.' },
                    { id: 'edu2', name: 'Universitetsstudier (grund)', duration: 3, costs: { economic: 30, time: 40, cultural: -10 }, requirements: { education_level: 'gymnasium', cultural: 40 }, benefits: { cultural: 50, symbolic: 20, happiness: 5 }, outcomes: { education_level: 'hÃ¶gskola' }, description: 'GrundlÃ¤ggande akademisk examen.' },
                    { id: 'edu3', name: 'Universitetsstudier (avancerad)', duration: 2, costs: { economic: 20, time: 30, cultural: -5 }, requirements: { education_level: 'hÃ¶gskola', cultural: 70 }, benefits: { cultural: 30, symbolic: 15 }, outcomes: { education_level: 'avancerad hÃ¶gskola' }, description: 'Masterexamen eller motsvarande.' },
                    { id: 'edu4', name: 'Yrkesskola/FolkhÃ¶gskola', duration: 2, costs: { economic: 15, time: 25 }, requirements: { age_min: 18 }, benefits: { cultural: 20, social: 10 }, outcomes: { education_level: 'yrkesutbildning' }, description: 'Praktisk utbildning fÃ¶r ett specifikt yrke.' },
                    { id: 'edu5', name: 'KvÃ¤llskurs/Kompetensutveckling', duration: 1, costs: { economic: 20, time: 10 }, requirements: {}, benefits: { cultural: 15, happiness: 5 }, description: 'FÃ¶rbÃ¤ttra dina fÃ¤rdigheter.' }
                ]
            },
            'Arbete': {
                color: '#28a745',
                projects: [
                    { id: 'work1', name: 'Enklare arbete (Deltid)', duration: 5, costs: { time: 25 }, requirements: { age_min: 16 }, benefits: { economic: 60, social: 5 }, outcomes: { hasJob: true }, description: 'FÃ¶rsta steget in pÃ¥ arbetsmarknaden.' },
                    { id: 'work2', name: 'Kvalificerat arbete', duration: 8, costs: { time: 50 }, requirements: { age_min: 20, education_level: ['gymnasium', 'yrkesutbildning','hÃ¶gskola'] }, benefits: { economic: 150, career: 20, symbolic: 10 }, outcomes: { hasJob: true }, description: 'Stabil anstÃ¤llning med utvecklingsmÃ¶jligheter.' },
                    { id: 'work3', name: 'Specialist/Chefsposition', duration: 10, costs: { time: 60 }, requirements: { age_min: 28, education_level: ['hÃ¶gskola', 'avancerad hÃ¶gskola'], cultural: 60, social: 40 }, benefits: { economic: 250, career: 30, symbolic: 25, happiness: -5 }, outcomes: { hasJob: true }, description: 'KrÃ¤vande men vÃ¤lbetalt arbete.' },
                    { id: 'work4', name: 'Starta Eget FÃ¶retag', duration: 6, costs: { economic: 100, time: 70, social: -10 }, requirements: { age_min: 25, cultural: 40, economic: 50 }, benefits: { economic: 200, career: 25, symbolic: 20, happiness: 10, health: -5 }, outcomes: { hasJob: true }, description: 'Riskfyllt men potentiellt givande.' },
                    { id: 'work5', name: 'Gig-arbete/Frilans', duration: 4, costs: { time: 30 }, requirements: { age_min: 18 }, benefits: { economic: 80, happiness: 5 }, outcomes: { hasJob: true }, description: 'Flexibelt men osÃ¤kert.' }
                ]
            },
            'Relationer': {
                color: '#dc3545',
                projects: [
                    { id: 'rel1', name: 'Skaffa Partner', duration: 2, costs: { time: 20, economic: 10 }, requirements: { age_min: 18 }, benefits: { happiness: 20, social: 15, health: 5 }, outcomes: { hasFamily: true }, description: 'Inled en seriÃ¶s relation.' },
                    { id: 'rel2', name: 'Gifta sig/Bli sambo', duration: 1, costs: { economic: 30, time: 10 }, requirements: { hasFamily: true }, benefits: { happiness: 15, symbolic: 10, social: 5 }, outcomes: { isMarried: true }, description: 'Formalisera fÃ¶rhÃ¥llandet.' },
                    { id: 'rel3', name: 'Skaffa Barn', duration: 5, costs: { economic: 80, time: 40, happiness: -10 }, requirements: { hasFamily: true, age_min: 22, age_max: 45 }, benefits: { happiness: 30, social: 10, symbolic: 5 }, outcomes: { hasChildren: true }, description: 'UtÃ¶ka familjen.' },
                    { id: 'rel4', name: 'UnderhÃ¥lla VÃ¤nskap', duration: 0, costs: { time: 15, economic: 10 }, requirements: {}, benefits: { happiness: 10, social: 20 }, description: 'Investera i ditt sociala nÃ¤tverk.' },
                    { id: 'rel5', name: 'GÃ¥ med i FÃ¶rening', duration: 0, costs: { time: 10, economic: 5 }, requirements: {}, benefits: { social: 15, happiness: 5, cultural: 5 }, description: 'Delta i gemensamma aktiviteter.' }
                ]
            },
            'Boende': {
                color: '#fd7e14',
                projects: [
                    { id: 'house1', name: 'Hyra LÃ¤genhet', duration: 0, costs: { economic: 40 }, requirements: {}, benefits: { happiness: 5 }, description: 'Flexibelt boende.' },
                    { id: 'house2', name: 'KÃ¶pa BostadsrÃ¤tt', duration: 0, costs: { economic: 150 }, requirements: { economic: 100, hasJob: true }, benefits: { economic: 20, happiness: 10, symbolic: 15 }, description: 'Investera i ditt boende.' },
                    { id: 'house3', name: 'KÃ¶pa Villa/Radhus', duration: 0, costs: { economic: 250 }, requirements: { economic: 200, hasJob: true, hasFamily: true }, benefits: { economic: 30, happiness: 15, symbolic: 20 }, description: 'FÃ¶r den vÃ¤xande familjen.' },
                    { id: 'house4', name: 'Flytta till StÃ¶rre Stad', duration: 1, costs: { economic: 30, time: 10, social: -5 }, requirements: {}, benefits: { cultural: 10, career: 5 }, description: 'SÃ¶k nya mÃ¶jligheter.' },
                    { id: 'house5', name: 'Flytta till Mindre Ort', duration: 1, costs: { economic: -10, time: 5, social: -5 }, requirements: {}, benefits: { happiness: 5, health: 5 }, description: 'NÃ¤rmare naturen, lugnare tempo.' }
                ]
            },
            'HÃ¤lsa & Fritid': {
                color: '#6f42c1',
                projects: [
                    { id: 'lei1', name: 'Regelbunden TrÃ¤ning', duration: 0, costs: { economic: 10, time: 15 }, requirements: {}, benefits: { health: 20, happiness: 10 }, blocked_by_if: { hasChildren: { time_cost_increase_factor: 1.5 } }, description: 'HÃ¥ll dig i form.' },
                    { id: 'lei2', name: 'Hobbyverksamhet', duration: 0, costs: { economic: 15, time: 10 }, requirements: {}, benefits: { happiness: 15, cultural: 5 }, reduced_by_if: { hasFamily: { time_cost_increase_factor: 1.2 } }, description: 'Odla dina intressen.' },
                    { id: 'lei3', name: 'Resa Utomlands', duration: 1, costs: { economic: 80, time: 10 }, requirements: { economic: 60 }, benefits: { happiness: 25, cultural: 15 }, blocked_by_if: { hasChildren: { probability_decrease_factor: 0.5 } }, description: 'UpptÃ¤ck vÃ¤rlden.' },
                    { id: 'lei4', name: 'Personlig Utveckling (Terapi/Coaching)', duration: 1, costs: { economic: 50, time: 5 }, requirements: {}, benefits: { happiness: 15, health: 5 }, description: 'Investera i ditt vÃ¤lmÃ¥ende.' },
                    { id: 'lei5', name: 'Semester i Sverige', duration: 1, costs: { economic: 30, time: 5 }, requirements: {}, benefits: { happiness: 10, health: 5 }, description: 'Koppla av pÃ¥ hemmaplan.' }
                ]
            },
             'SamhÃ¤lle & Kultur': {
                color: '#20c997',
                projects: [
                    { id: 'soc1', name: 'Politiskt Engagemang', duration: 2, costs: { time: 15, economic: 5 }, requirements: { cultural: 30 }, benefits: { social: 10, symbolic: 10, happiness: 5 }, description: 'PÃ¥verka samhÃ¤llet.' },
                    { id: 'soc2', name: 'VolontÃ¤rarbete', duration: 1, costs: { time: 10 }, requirements: {}, benefits: { social: 15, happiness: 10, symbolic: 5 }, description: 'GÃ¶r en insats fÃ¶r andra.' },
                    { id: 'soc3', name: 'Kulturkonsumtion (Teater, Museum etc.)', duration: 0, costs: { economic: 15, time: 5 }, requirements: {}, benefits: { cultural: 10, happiness: 5 }, description: 'Utvidga dina vyer.' }
                ]
            }
        };

        const randomEventTypes = {
            positive: [
                { title: 'OvÃ¤ntat arv', description: 'En avlÃ¤gsen slÃ¤kting har testamenterat en summa pengar till dig.', effects: { capital: { economic: 75 }, stats: { happiness: 10 } }, probability: 0.03, class_modifier: { 'Ã–verklass': 1.5, 'Arbetarklass': 0.8 } },
                { title: 'Jobberbjudande via nÃ¤tverk', description: 'En kontakt tipsar om ett spÃ¤nnande jobb som passar dig perfekt.', effects: { capital: { career: 10, social: 5, symbolic: 5 } }, probability: 0.05, requirements: { capital_min: { social: 30 } } },
                { title: 'Nyckelperson i ditt liv', description: 'Du trÃ¤ffar nÃ¥gon som blir en viktig vÃ¤n eller mentor.', effects: { capital: { social: 15 }, stats: { happiness: 10 } }, probability: 0.08 },
                { title: 'Stipendium/Bidrag', description: 'Du beviljas ekonomiskt stÃ¶d fÃ¶r en utbildning eller ett projekt.', effects: { capital: { economic: 40, cultural: 5 } }, probability: 0.04, requirements: { constraints_any: {education_level: ['gymnasium', 'hÃ¶gskola'] } } },
                { title: 'Lottovinst', description: 'Turen Ã¤r pÃ¥ din sida! En mindre lottovinst.', effects: { capital: { economic: 25 }, stats: { happiness: 5 } }, probability: 0.02 }
            ],
            negative: [
                { title: 'Sjukdomsperiod', description: 'Du drabbas av en sjukdom som pÃ¥verkar din arbetsfÃ¶rmÃ¥ga och hÃ¤lsa.', effects: { stats: { health: -15, happiness: -10 }, capital: { economic: -20, time: -10 } }, probability: 0.06 },
                { title: 'Varsel pÃ¥ jobbet', description: 'FÃ¶retaget gÃ¥r dÃ¥ligt och du blir varslad om uppsÃ¤gning.', effects: { capital: { career: -15, economic: -30 }, stats: { happiness: -15 } }, probability: 0.04, requirements: { constraints_is: { hasJob: true } }, class_modifier: { 'Arbetarklass': 1.3, 'Ã–verklass': 0.7 } },
                { title: 'Relationskonflikt', description: 'En konflikt uppstÃ¥r i en nÃ¤ra relation.', effects: { stats: { happiness: -10 }, capital: { social: -10 } }, probability: 0.07 },
                { title: 'Ekonomisk motgÃ¥ng', description: 'OvÃ¤ntade utgifter eller en dÃ¥lig investering drabbar din ekonomi.', effects: { capital: { economic: -50 }, stats: { happiness: -5 } }, probability: 0.05 },
                { title: 'Global lÃ¥gkonjunktur', description: 'En internationell ekonomisk nedgÃ¥ng pÃ¥verkar jobbmÃ¶jligheter och investeringar.', effects: { capital: { economic: -40, career: -5 } }, probability: 0.03, decade_modifier: { 3: 1.5, 4: 1.2 } } // Mer sannolikt pÃ¥ 90-talet & 00-talet
            ],
            neutral: [
                { title: 'Flytt till ny stad', description: 'En jobbmÃ¶jlighet eller personliga skÃ¤l leder till en flytt.', effects: { capital: { social: -5, cultural: 5 } }, probability: 0.05 },
                { title: 'Teknologisk fÃ¶rÃ¤ndring', description: 'Ny teknik fÃ¶rÃ¤ndrar din bransch eller vardag.', effects: { capital: { cultural: 5 } }, probability: 0.06, decade_modifier: { 2: 1.2, 3: 1.5, 4: 1.8, 5: 2.0 } }, // Mer sannolikt i senare decennier
                { title: 'SamhÃ¤llsdebatt engagerar', description: 'En aktuell samhÃ¤llsfrÃ¥ga vÃ¤cker ditt intresse.', effects: { capital: { cultural: 5 } }, probability: 0.07 }
            ]
        };

        // --- UI HELPER FUNCTIONS ---
        function showScreen(screenId) {
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('characterScreen').style.display = 'none';
            document.getElementById('gameplayScreen').style.display = 'none';
            document.getElementById('reflectionScreen').style.display = 'none';
            document.getElementById('summaryScreen').style.display = 'none';
            if (document.getElementById(screenId)) {
                document.getElementById(screenId).style.display = 'block';
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId, title, description) {
            document.getElementById(modalId).style.display = 'flex';
            if (title) document.getElementById(modalId.replace('Modal', 'Title')).innerText = title;
            if (description) document.getElementById(modalId.replace('Modal', 'Description')).innerText = description;
        }

        // --- CHARACTER CREATION ---
        function weightedRandom(items) {
            let totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            for (let item of items) {
                if (randomNum < item.weight) return item;
                randomNum -= item.weight;
            }
            return items[items.length - 1];
        }

        function createCharacter() {
            const gender = Math.random() < 0.5 ? 'Kvinna' : 'Man';
            const birthplace = weightedRandom(swedishCities);
            const socialClass = weightedRandom(socialClasses);

            gameState.character = {
                gender: gender,
                birthplace: birthplace.name,
                socialClass: socialClass.name,
                region: birthplace.region,
                opportunitiesModifier: socialClass.opportunitiesModifier,
                classDetails: socialClass // Store full class details
            };

            // Set initial capital based on social class
            Object.assign(gameState.capital, socialClass.initialCapital);
            gameState.capital.time = INITIAL_TIME_PER_DECADE; // Reset time for the first decade

            const infoDiv = document.getElementById('characterInfo');
            infoDiv.innerHTML = `
                <h3>Din start i livet:</h3>
                <p><strong>KÃ¶n:</strong> ${gameState.character.gender}</p>
                <p><strong>FÃ¶delseort:</strong> ${gameState.character.birthplace} (${gameState.character.region})</p>
                <p><strong>Social bakgrund:</strong> ${gameState.character.socialClass}</p>
                <div class="character-stats">
                    <div class="stat-item"><strong>Ekonomiskt Kapital:</strong> ${gameState.capital.economic}</div>
                    <div class="stat-item"><strong>Kulturellt Kapital:</strong> ${gameState.capital.cultural}</div>
                    <div class="stat-item"><strong>Socialt Kapital:</strong> ${gameState.capital.social}</div>
                    <div class="stat-item"><strong>Symboliskt Kapital:</strong> ${gameState.capital.symbolic}</div>
                </div>
            `;
        }

        // --- GAME FLOW ---
        function startGame() {
            gameState = getDefaultGameState();
            createCharacter();
            showScreen('characterScreen');
        }
        
        function restartGame() {
            gameState = getDefaultGameState(); // Reset game state
            showScreen('introScreen');
        }

        function startFirstDecade() {
            gameState.currentDecadeIndex = 0;
            gameState.age = 10; // Start age for the first decade planning (e.g. teens)
            setupDecade();
        }
        
        function setupDecade() {
            gameState.age += 10; // Character ages 10 years each decade
            gameState.capital.time = INITIAL_TIME_PER_DECADE; // Reset time budget for the decade
            gameState.currentDecadeProjects = []; // Clear projects from previous decade
            if (!gameState.decadeLog[gameState.currentDecadeIndex]) {
                 gameState.decadeLog[gameState.currentDecadeIndex] = { projects: [], events: [] };
            }


            document.getElementById('decadeHeader').innerHTML = `
                <h2>${gameState.decades[gameState.currentDecadeIndex]} (Ã…lder: ${gameState.age}-${gameState.age+9})</h2>
                <p>Planera dina kommande 10 Ã¥r.</p>
            `;
            updateCharacterDisplay();
            renderHistoricalEvents();
            renderProjects();
            updateCurrentProjectsDisplay(); // Ensure it's cleared initially
            
            // Trigger random events at the start of the decade
            triggerRandomEvents();

            showScreen('gameplayScreen');
        }

        function nextDecade() {
            gameState.currentDecadeIndex++;
            if (gameState.currentDecadeIndex < gameState.decades.length) {
                setupDecade();
            } else {
                showFinalSummary();
            }
        }
        
        function updateCharacterDisplay() {
            const displayDiv = document.getElementById('characterDisplay');
            let capitalHTML = '<div class="character-stats">';
            for (const [key, value] of Object.entries(gameState.capital)) {
                capitalHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</div>`;
            }
            capitalHTML += '</div>';

            let statsHTML = '<div class="character-stats" style="margin-top:10px;">';
             for (const [key, value] of Object.entries(gameState.stats)) {
                statsHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</div>`;
            }
            statsHTML += '</div>';

            let constraintsHTML = '<div style="margin-top:10px; font-size:0.9em;"><strong>Nuvarande status:</strong> ';
            constraintsHTML += `Utbildning: ${gameState.constraints.education_level}, `;
            constraintsHTML += `Jobb: ${gameState.constraints.hasJob ? 'Ja' : 'Nej'}, `;
            constraintsHTML += `Gift/Sambo: ${gameState.constraints.isMarried ? 'Ja' : 'Nej'}, `;
            constraintsHTML += `Barn: ${gameState.constraints.hasChildren ? 'Ja' : 'Nej'}`;
            constraintsHTML += '</div>';

            displayDiv.innerHTML = `
                <h3>Din status (Ã…lder: ${gameState.age})</h3>
                <p><strong>Klass:</strong> ${gameState.character.socialClass}, <strong>KÃ¶n:</strong> ${gameState.character.gender}</p>
                <h4>Kapital:</h4>
                ${capitalHTML}
                <h4>Livskvalitet:</h4>
                ${statsHTML}
                ${constraintsHTML}
            `;
            document.getElementById('timeSpent').innerText = gameState.currentDecadeProjects.reduce((sum, p) => sum + p.costs.time, 0);
            document.getElementById('totalTimePerDecade').innerText = INITIAL_TIME_PER_DECADE;
        }

        function renderHistoricalEvents() {
            const eventsContainer = document.getElementById('historicalEventsDisplay');
            const decadeEvents = historicalEventsData[gameState.currentDecadeIndex];
            if (decadeEvents) {
                let html = `<h3>Historiska hÃ¤ndelser: ${decadeEvents.title}</h3><ul>`;
                decadeEvents.events.forEach(event => {
                    html += `<li>${event}</li>`;
                });
                html += `</ul>`;
                eventsContainer.innerHTML = html;
                eventsContainer.style.display = 'block';
            } else {
                eventsContainer.style.display = 'none';
            }
        }

        // --- PROJECT HANDLING ---
        function meetsRequirements(project) {
            // Age requirement
            if (project.requirements.age_min && gameState.age < project.requirements.age_min) return false;
            if (project.requirements.age_max && gameState.age > project.requirements.age_max) return false;

            // Capital requirements
            if (project.requirements.capital_min) {
                for (const cap_type in project.requirements.capital_min) {
                    if (gameState.capital[cap_type] < project.requirements.capital_min[cap_type]) return false;
                }
            }
             // Resource costs (economic, time)
            if (project.costs.economic && gameState.capital.economic < project.costs.economic) return false;
             // We don't check time cost here, but rather when adding.

            // Education level requirement
            if (project.requirements.education_level) {
                const currentLevel = gameState.constraints.education_level;
                const requiredLevels = Array.isArray(project.requirements.education_level) ? project.requirements.education_level : [project.requirements.education_level];
                if (!requiredLevels.includes(currentLevel)) {
                     // Allow higher education if current level is part of a hierarchy
                    const eduHierarchy = ['grundskola', 'gymnasium', 'yrkesutbildning', 'hÃ¶gskola', 'avancerad hÃ¶gskola'];
                    let currentIdx = eduHierarchy.indexOf(currentLevel);
                    let requiredIdx = Math.min(...requiredLevels.map(rl => eduHierarchy.indexOf(rl)));
                    if (currentIdx < requiredIdx) return false;
                }
            }
            
            // Other specific capital type requirements (e.g. cultural for some studies)
            if (project.requirements.cultural && gameState.capital.cultural < project.requirements.cultural) return false;
            if (project.requirements.social && gameState.capital.social < project.requirements.social) return false;

            // Constraint requirements (e.g., must be married, must have job)
            if (project.requirements.constraints_is) {
                for (const key in project.requirements.constraints_is) {
                    if (gameState.constraints[key] !== project.requirements.constraints_is[key]) return false;
                }
            }
             // Specific constraints (e.g. hasFamily, hasJob) from gameState.constraints
            if (project.requirements.hasFamily && !gameState.constraints.hasFamily) return false;
            if (project.requirements.hasJob && !gameState.constraints.hasJob) return false;


            // Check blocked_by_if conditions
            if (project.blocked_by_if) {
                for (const constraintKey in project.blocked_by_if) {
                    if (gameState.constraints[constraintKey]) { // If the blocking constraint is true
                        const blockCondition = project.blocked_by_if[constraintKey];
                        if (blockCondition.probability_decrease_factor) { // This is more for events, but can be adapted
                             if (Math.random() < blockCondition.probability_decrease_factor) return false; // Project becomes unavailable sometimes
                        } else {
                            return false; // Hard block
                        }
                    }
                }
            }

            return true;
        }
        
        function getAdjustedProjectCost(project, costType) {
            let baseCost = project.costs[costType] || 0;
            if (project.reduced_by_if) {
                for (const constraintKey in project.reduced_by_if) {
                    if (gameState.constraints[constraintKey]) { // If the reducing constraint is true
                        const reduction = project.reduced_by_if[constraintKey];
                        if (reduction.time_cost_increase_factor && costType === 'time') {
                             baseCost *= reduction.time_cost_increase_factor;
                        }
                         // Can add more reduction types here
                    }
                }
            }
            return Math.round(baseCost);
        }


        function renderProjects() {
            const menuDiv = document.getElementById('projectMenu');
            menuDiv.innerHTML = '';
            const totalTimeSpentOnProjects = gameState.currentDecadeProjects.reduce((sum, p) => sum + getAdjustedProjectCost(p, 'time'), 0);

            for (const categoryName in projectCategories) {
                const category = projectCategories[categoryName];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'project-category';
                categoryDiv.innerHTML = `<h4>${categoryName}</h4>`;

                category.projects.forEach(project => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'project-item';
                    
                    const actualTimeCost = getAdjustedProjectCost(project, 'time');
                    const actualEconomicCost = getAdjustedProjectCost(project, 'economic');

                    let titleText = `${project.name}`;
                    if (project.duration > 0) titleText += ` (${project.duration} Ã¥r)`;
                    
                    let costText = `Tid: ${actualTimeCost}`;
                    if (actualEconomicCost > 0) costText += `, Eko: ${actualEconomicCost}`;
                    else if (project.costs.economic < 0) costText += `, Eko: +${Math.abs(actualEconomicCost)}`; // Income shown as +

                    itemDiv.innerHTML = `${titleText}<small>${project.description}<br><strong>Kostnad:</strong> ${costText}</small>`;
                    
                    const canAffordTime = (totalTimeSpentOnProjects + actualTimeCost) <= INITIAL_TIME_PER_DECADE;
                    const canAffordEconomic = gameState.capital.economic >= (actualEconomicCost > 0 ? actualEconomicCost : 0) ;
                    
                    if (meetsRequirements(project) && canAffordTime && canAffordEconomic) {
                        itemDiv.onclick = () => selectProject(project);
                    } else {
                        itemDiv.classList.add('disabled');
                        let reason = "";
                        if (!meetsRequirements(project)) reason += "Krav ej uppfyllda. ";
                        if (!canAffordTime) reason += "Inte tillrÃ¤ckligt med tid kvar. ";
                        if (!canAffordEconomic) reason += "Inte tillrÃ¤ckligt med ekonomiskt kapital. ";
                        itemDiv.title = reason.trim();
                    }
                    categoryDiv.appendChild(itemDiv);
                });
                menuDiv.appendChild(categoryDiv);
            }
        }
        
        function selectProject(project) {
            const actualTimeCost = getAdjustedProjectCost(project, 'time');
            const actualEconomicCost = getAdjustedProjectCost(project, 'economic');
            const totalTimeSpentOnProjects = gameState.currentDecadeProjects.reduce((sum, p) => sum + getAdjustedProjectCost(p, 'time'), 0);

            if ((totalTimeSpentOnProjects + actualTimeCost) > INITIAL_TIME_PER_DECADE) {
                showModal('randomEventModal', 'FÃ¶r lite tid', 'Du har inte tillrÃ¤ckligt med tid kvar detta decennium fÃ¶r detta projekt.');
                return;
            }
            if (gameState.capital.economic < (actualEconomicCost > 0 ? actualEconomicCost : 0)) {
                 showModal('randomEventModal', 'FÃ¶r lite pengar', 'Du har inte rÃ¥d med detta projekt.');
                return;
            }

            // Deduct economic cost immediately upon selection
            if (actualEconomicCost > 0) {
                gameState.capital.economic -= actualEconomicCost;
            } else if (actualEconomicCost < 0) { // If it's an income project selected now (e.g. selling something)
                 gameState.capital.economic += Math.abs(actualEconomicCost);
            }

            // For simplicity, we store the project reference. Costs/benefits applied at decade end.
            // Actual time is "spent" by adding to list.
            gameState.currentDecadeProjects.push(project);
            
            updateCharacterDisplay();
            renderProjects(); // Re-render to update availability based on new capital/time
            updateCurrentProjectsDisplay();
        }

        function updateCurrentProjectsDisplay() {
            const display = document.getElementById('currentProjectsDisplay');
            const timeSpentOnProjects = gameState.currentDecadeProjects.reduce((sum, p) => sum + getAdjustedProjectCost(p, 'time'), 0);
            document.getElementById('timeSpent').innerText = timeSpentOnProjects;

            if (gameState.currentDecadeProjects.length === 0) {
                display.innerHTML = '<p><em>Inga projekt valda Ã¤n.</em></p>';
                return;
            }
            display.innerHTML = '';
            gameState.currentDecadeProjects.forEach(p => {
                const category = Object.values(projectCategories).find(cat => cat.projects.includes(p));
                const pDiv = document.createElement('div');
                pDiv.classList.add('project-entry');
                pDiv.style.backgroundColor = category ? category.color : '#ccc';
                pDiv.textContent = `${p.name} (Tid: ${getAdjustedProjectCost(p, 'time')}${p.costs.economic ? ', Eko: ' + getAdjustedProjectCost(p, 'economic') : ''})`;
                display.appendChild(pDiv);
            });
        }
        
        function clearCurrentDecadeProjects() {
            // Refund any upfront economic costs
            gameState.currentDecadeProjects.forEach(project => {
                const actualEconomicCost = getAdjustedProjectCost(project, 'economic');
                 if (actualEconomicCost > 0) {
                    gameState.capital.economic += actualEconomicCost;
                } else if (actualEconomicCost < 0) {
                    gameState.capital.economic -= Math.abs(actualEconomicCost);
                }
            });

            gameState.currentDecadeProjects = [];
            updateCharacterDisplay();
            renderProjects();
            updateCurrentProjectsDisplay();
        }

        function completeDecade() {
            let reflectionHTML = `<h3>Sammanfattning fÃ¶r ${gameState.decades[gameState.currentDecadeIndex]} (Ã…lder ${gameState.age}-${gameState.age+9}):</h3>`;
            reflectionHTML += "<h4>GenomfÃ¶rda projekt:</h4><ul>";

            if (gameState.currentDecadeProjects.length === 0) {
                reflectionHTML += "<li>Inga stÃ¶rre projekt genomfÃ¶rdes detta decennium.</li>";
            }

            gameState.currentDecadeProjects.forEach(project => {
                reflectionHTML += `<li><strong>${project.name}</strong>: `;
                let effectSummary = [];

                // Apply benefits (capital & stats)
                if (project.benefits) {
                    for (const type in project.benefits) { // economic, cultural, social, symbolic, career, happiness, health
                        if (gameState.capital.hasOwnProperty(type)) {
                            gameState.capital[type] += project.benefits[type];
                            effectSummary.push(`${type}: +${project.benefits[type]}`);
                        } else if (gameState.stats.hasOwnProperty(type)) {
                            gameState.stats[type] += project.benefits[type];
                            effectSummary.push(`${type}: +${project.benefits[type]}`);
                        } else if (type === 'career') { // Special handling for career points
                            gameState.capital.symbolic += project.benefits[type] * 0.5; // Career can give symbolic capital
                             gameState.capital.economic += project.benefits[type] * 2; // And some economic boost proxy
                            effectSummary.push(`karriÃ¤rpoÃ¤ng: +${project.benefits[type]}`);
                        }
                    }
                }
                // Apply costs (time was conceptually spent, economic was upfront)
                // Other non-time/economic costs if any (e.g. project.costs.cultural = -5 means it cost cultural capital)
                if(project.costs){
                    for(const type in project.costs){
                        if(type !== 'time' && type !== 'economic' && gameState.capital.hasOwnProperty(type)){
                            gameState.capital[type] += project.costs[type]; // Will be negative if it's a cost
                            effectSummary.push(`${type}: ${project.costs[type]}`);
                        }
                         else if (type !== 'time' && type !== 'economic' && gameState.stats.hasOwnProperty(type)){
                            gameState.stats[type] += project.costs[type];
                             effectSummary.push(`${type}: ${project.costs[type]}`);
                        }
                    }
                }


                // Update constraints based on project outcomes
                if (project.outcomes) {
                    for (const key in project.outcomes) {
                        gameState.constraints[key] = project.outcomes[key];
                        effectSummary.push(`Ny status: ${key} -> ${project.outcomes[key]}`);
                    }
                }
                reflectionHTML += effectSummary.join(', ') + "</li>";
                gameState.allCompletedProjects.push(project.name); // Add to overall list
                gameState.decadeLog[gameState.currentDecadeIndex].projects.push({name: project.name, effects: effectSummary.join(', ')});
            });
            reflectionHTML += "</ul>";

            // Apply historical modifiers for the decade (if any)
            const histModifiers = historicalEventsData[gameState.currentDecadeIndex].modifiers;
            if (histModifiers) {
                reflectionHTML += "<h4>PÃ¥verkan frÃ¥n samhÃ¤llsutvecklingen:</h4><ul>";
                if (histModifiers.economic_growth) {
                    let growth = Math.round(gameState.capital.economic * histModifiers.economic_growth);
                    gameState.capital.economic += growth;
                    reflectionHTML += `<li>Ekonomisk tillvÃ¤xt/nedgÃ¥ng: ${growth > 0 ? '+' : ''}${growth} ekonomiskt kapital.</li>`;
                }
                if (histModifiers.social_change) {
                    let change = Math.round(gameState.capital.social * histModifiers.social_change);
                    gameState.capital.social += change;
                     reflectionHTML += `<li>Social fÃ¶rÃ¤ndring: ${change > 0 ? '+' : ''}${change} socialt kapital.</li>`;
                }
                 if (histModifiers.cultural_change) {
                    let change = Math.round(gameState.capital.cultural * histModifiers.cultural_change);
                    gameState.capital.cultural += change;
                     reflectionHTML += `<li>Kulturell fÃ¶rÃ¤ndring: ${change > 0 ? '+' : ''}${change} kulturellt kapital.</li>`;
                }
                // Add more historical modifiers as needed
                reflectionHTML += "</ul>";
            }


            document.getElementById('reflectionContent').innerHTML = reflectionHTML;
            
            const decadeEventsLog = gameState.decadeLog[gameState.currentDecadeIndex].events;
            const eventsListElement = document.querySelector("#decadeEvents ul");
            eventsListElement.innerHTML = ''; // Clear previous
            if(decadeEventsLog.length > 0){
                decadeEventsLog.forEach(event => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${event.title}:</strong> ${event.description} <em>(${event.effects})</em>`;
                    eventsListElement.appendChild(li);
                });
                document.getElementById("decadeEvents").style.display = 'block';
            } else {
                 document.getElementById("decadeEvents").style.display = 'none';
            }


            // Clamp stats
            gameState.stats.health = Math.max(0, Math.min(100, gameState.stats.health));
            gameState.stats.happiness = Math.max(0, Math.min(100, gameState.stats.happiness));

            if (gameState.currentDecadeIndex >= gameState.decades.length -1) {
                document.getElementById('nextDecadeButton').innerText = "Se livssammanfattning";
            } else {
                 document.getElementById('nextDecadeButton').innerText = "NÃ¤sta decennium";
            }

            showScreen('reflectionScreen');
        }
        
        // --- RANDOM EVENTS ---
        function triggerRandomEvents() {
            const eventCategories = ['positive', 'negative', 'neutral'];
            let eventTriggeredThisDecade = false;

            for (const category of eventCategories) {
                for (const event of randomEventTypes[category]) {
                    let probability = event.probability;

                    // Adjust probability based on social class
                    if (event.class_modifier && gameState.character.classDetails.name in event.class_modifier) {
                        probability *= event.class_modifier[gameState.character.classDetails.name];
                    }
                    // Adjust probability based on gender (if implemented in event data)
                    // e.g. if (event.gender_modifier && gameState.character.gender in event.gender_modifier)

                    // Adjust probability based on current decade (if applicable)
                    if (event.decade_modifier && gameState.currentDecadeIndex in event.decade_modifier) {
                        probability *= event.decade_modifier[gameState.currentDecadeIndex];
                    }
                    
                    // Multiply by character's general opportunity modifier
                    probability *= gameState.character.opportunitiesModifier;


                    if (Math.random() < probability) {
                        let canTrigger = true;
                        // Check requirements for the event
                        if (event.requirements) {
                            if (event.requirements.capital_min) {
                                for (const cap_type in event.requirements.capital_min) {
                                    if (gameState.capital[cap_type] < event.requirements.capital_min[cap_type]) canTrigger = false;
                                }
                            }
                            if (event.requirements.constraints_is) {
                                for (const key in event.requirements.constraints_is) {
                                    if (gameState.constraints[key] !== event.requirements.constraints_is[key]) canTrigger = false;
                                }
                            }
                             if (event.requirements.constraints_any) { // e.g. must have one of several education levels
                                let metAnyConstraint = false;
                                for (const key in event.requirements.constraints_any) {
                                    const requiredValues = Array.isArray(event.requirements.constraints_any[key]) ? event.requirements.constraints_any[key] : [event.requirements.constraints_any[key]];
                                    if (requiredValues.includes(gameState.constraints[key])) {
                                        metAnyConstraint = true;
                                        break;
                                    }
                                }
                                if (!metAnyConstraint) canTrigger = false;
                            }
                        }

                        if (canTrigger) {
                            applyEventEffect(event);
                            showModal('randomEventModal', `SlumpmÃ¤ssig hÃ¤ndelse: ${event.title}`, event.description);
                            eventTriggeredThisDecade = true; // For simplicity, allow multiple events, but this flag could limit to one major.
                            // break; // Optional: only one event per category per decade? Or one total?
                        }
                    }
                }
                // if (eventTriggeredThisDecade && category !== 'neutral') break; // Optional: only one major (pos/neg) event per decade
            }
        }

        function applyEventEffect(event) {
            let effectSummary = [];
            if (event.effects.capital) {
                for (const type in event.effects.capital) {
                    gameState.capital[type] = (gameState.capital[type] || 0) + event.effects.capital[type];
                     effectSummary.push(`${type}: ${event.effects.capital[type] > 0 ? '+' : ''}${event.effects.capital[type]}`);
                }
            }
            if (event.effects.stats) {
                for (const type in event.effects.stats) {
                    gameState.stats[type] = (gameState.stats[type] || 0) + event.effects.stats[type];
                    effectSummary.push(`${type}: ${event.effects.stats[type] > 0 ? '+' : ''}${event.effects.stats[type]}`);
                }
            }
            if (event.effects.constraints) { // If event changes a constraint
                for (const type in event.effects.constraints) {
                    gameState.constraints[type] = event.effects.constraints[type];
                     effectSummary.push(`Ny status: ${type} -> ${event.effects.constraints[type]}`);
                }
            }
            // Log event
            if(!gameState.decadeLog[gameState.currentDecadeIndex]) gameState.decadeLog[gameState.currentDecadeIndex] = {projects: [], events: []};
            gameState.decadeLog[gameState.currentDecadeIndex].events.push({
                title: event.title,
                description: event.description,
                effects: effectSummary.join(', ') || "Inga direkta effekter."
            });
            updateCharacterDisplay(); // Update display after event
        }

        // --- FINAL SUMMARY ---
        function showFinalSummary() {
            const summaryDiv = document.getElementById('lifeSummary');
            summaryDiv.innerHTML = ''; // Clear previous summary

            let finalCapitalHTML = `<h4>Slutligt Kapital:</h4><div class="character-stats">`;
            for (const [key, value] of Object.entries(gameState.capital)) {
                finalCapitalHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</div>`;
            }
            finalCapitalHTML += `</div>`;
            
            let finalStatsHTML = `<h4>Slutlig Livskvalitet:</h4><div class="character-stats">`;
             for (const [key, value] of Object.entries(gameState.stats)) {
                finalStatsHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${value}</div>`;
            }
            finalStatsHTML += `</div>`;

            document.getElementById('finalStats').innerHTML = `${finalCapitalHTML}${finalStatsHTML}`;

            // Summary of completed projects
            const projectsCard = document.createElement('div');
            projectsCard.className = 'summary-card';
            projectsCard.innerHTML = '<h4>GenomfÃ¶rda Livsprojekt:</h4><ul>' + 
                (gameState.allCompletedProjects.length > 0 ? gameState.allCompletedProjects.map(p => `<li>${p}</li>`).join('') : '<li>Inga stÃ¶rre projekt registrerade.</li>') + 
                '</ul>';
            summaryDiv.appendChild(projectsCard);

            // Summary of significant events per decade
            const eventsCard = document.createElement('div');
            eventsCard.className = 'summary-card';
            eventsCard.innerHTML = '<h4>Noterbara HÃ¤ndelser Genom Ã…ren:</h4>';
            const eventsList = document.createElement('ul');
            gameState.decadeLog.forEach((log, index) => {
                if (log.events.length > 0) {
                    const decadeTitle = document.createElement('li');
                    decadeTitle.innerHTML = `<strong>${gameState.decades[index]}:</strong>`;
                    const subList = document.createElement('ul');
                    log.events.forEach(event => {
                        const eventItem = document.createElement('li');
                        eventItem.innerHTML = `${event.title} - <em>${event.effects}</em>`;
                        subList.appendChild(eventItem);
                    });
                    decadeTitle.appendChild(subList);
                    eventsList.appendChild(decadeTitle);
                }
            });
            if (eventsList.childNodes.length === 0) {
                eventsList.innerHTML = '<li>Inga speciella hÃ¤ndelser registrerade.</li>';
            }
            eventsCard.appendChild(eventsList);
            summaryDiv.appendChild(eventsCard);
            
            // Overall reflection based on final capital/stats (simple version)
            const reflectionCard = document.createElement('div');
            reflectionCard.className = 'summary-card';
            let reflectionText = "<h4>Summering av ditt liv:</h4><p>";
            if (gameState.stats.happiness > 70 && gameState.capital.economic > 300) {
                reflectionText += "Du verkar ha levt ett framgÃ¥ngsrikt och lyckligt liv, med god ekonomi och mÃ¥nga upplevelser.";
            } else if (gameState.stats.happiness > 50 || gameState.capital.social > 50) {
                reflectionText += "Ditt liv hade sina upp- och nedgÃ¥ngar, men du byggde starka relationer och fann stunder av glÃ¤dje.";
            } else {
                reflectionText += "Livet var kanske inte alltid lÃ¤tt, men varje erfarenhet har format dig.";
            }
            reflectionText += ` Du nÃ¥dde en Ã¥lder av ${gameState.age + 9} Ã¥r.`;
            reflectionText += "</p>";
            reflectionCard.innerHTML = reflectionText;
            summaryDiv.appendChild(reflectionCard);


            showScreen('summaryScreen');
        }

        // Initial call to show intro
        showScreen('introScreen');

    </script>
</body>
</html>
