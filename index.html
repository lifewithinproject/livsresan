<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livslinjen - En svensk resa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Changed for longer content */
            padding: 20px; /* Added padding for scroll */
            overflow-y: auto; /* Allow body to scroll */
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 20px auto; /* Adjusted margin */
            padding: 0 10px; /* Prevent content flush with edges */
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
         .header p {
            font-size: 1.1em;
        }

        .game-screen {
            background: rgba(255, 255, 255, 0.97); /* Slightly more opaque */
            border-radius: 15px;
            padding: 20px 30px; /* Adjusted padding */
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px; /* Space at the bottom */
        }

        .character-info, .decade-summary, .life-goal-selection {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #007bff;
        }
        .character-info h3, .decade-summary h3, .life-goal-selection h3 {
            margin-top:0;
            margin-bottom: 15px;
            color: #0056b3;
        }
        .life-goal-selection label {
            display: block;
            margin-bottom: 10px;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .life-goal-selection label:hover {
            background-color: #e9ecef;
        }
        .life-goal-selection input[type="radio"] {
            margin-right: 10px;
        }


        .character-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-size: 0.9em;
        }
        .stat-item strong {
            color: #007bff;
        }

        .timeline-container {
            margin: 20px 0;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 10px;
        }
        .timeline-container h3 {
             color: #333;
             margin-bottom: 10px;
        }
        .timeline-slots {
            display: flex;
            flex-wrap: wrap; /* Allow slots to wrap on small screens */
            background: #e9ecef;
            border-radius: 5px;
            padding: 10px;
            min-height: 60px; /* Ensure it has some height */
        }
        .timeline-slot {
            border: 1px dashed #ccc;
            background-color: #fff;
            padding: 5px;
            margin: 2px;
            min-height: 40px; /* Make slots visible */
            text-align: center;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            border-radius: 3px;
        }
        .timeline-slot.project-year {
            color: white;
            font-weight: bold;
            border-style: solid;
        }


        #currentProjectsDisplay { /* Used for summary list of projects */
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
            margin-top:10px;
        }
        #currentProjectsDisplay p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        #currentProjectsDisplay .project-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
        }


        .project-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Slightly wider */
            gap: 15px;
            margin: 20px 0;
        }

        .project-category {
            background: white;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .project-category:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .project-category h4 {
            margin-bottom: 10px;
            color: #495057;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }

        .project-item {
            background: #f8f9fa;
            padding: 10px 12px; /* Increased padding */
            margin: 8px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            font-size: 0.9em;
        }
        .project-item:hover {
            background: #e3f2fd;
            border-color: #007bff;
        }
        .project-item.disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .project-item small {
            display: block;
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 4px;
            line-height: 1.4;
        }


        .historical-events, .random-event-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .historical-events h3, .random-event-display h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        .historical-events ul, .random-event-display ul {
            list-style-position: inside;
            padding-left: 0;
        }
         .random-event-display p {
            margin-bottom: 5px;
        }


        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
        }
        .btn-danger:hover {
             transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }


        .decade-header {
            text-align: center;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .decade-header h2 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .reflection-screen {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
         .reflection-screen h2, .summary-screen h2 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }

        .life-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Wider cards */
            gap: 20px;
            margin: 20px 0;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .summary-card h4 {
            color: #007bff;
            margin-bottom: 10px;
        }
        .summary-card ul {
            list-style-type: none;
            padding-left: 0;
        }
        .summary-card li {
            margin-bottom: 8px; /* Increased spacing */
            font-size: 0.95em;
        }
        .summary-card li ul li { /* For nested lists in summary */
             font-size: 0.9em;
             margin-left: 15px;
             margin-top: 3px;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h3 {
            color: #007bff;
            margin-bottom: 15px;
        }
        .modal-content p {
            margin-bottom: 20px;
            line-height: 1.6;
        }


        .intro-screen {
            text-align: left; /* Changed for better readability */
            padding: 30px;
        }

        .intro-screen h2 {
            color: #007bff;
            margin-bottom: 20px;
            text-align: center;
        }
        .intro-screen h3 {
            color: #0056b3;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .intro-screen p, .intro-screen li {
            font-size: 1.05em; /* Slightly larger */
            line-height: 1.7; /* Increased line height */
            margin-bottom: 10px;
            color: #333; /* Darker text */
        }
        .intro-screen ul {
            list-style-position: inside;
            margin-left: 5px;
            margin-bottom:15px;
        }
        .intro-screen strong {
            color: #0056b3;
        }


        @media (max-width: 768px) {
            body {
                 padding: 10px;
            }
            .container {
                padding: 0px;
            }
            .game-screen {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .project-menu {
                grid-template-columns: 1fr;
            }
            .character-stats {
                grid-template-columns: 1fr;
            }
            .timeline-slots {
                flex-direction: column; /* Stack slots vertically on small screens */
            }
            .timeline-slot {
                width: 100%; /* Full width for stacked slots */
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🇸🇪 Livslinjen - En svensk resa</h1>
            <p>Ett sociologiskt simulationsspel om att växa upp i Sverige 1960-2020</p>
        </div>

        <div id="gameArea" class="game-screen">
            <div id="introScreen" class="intro-screen">
                <h2>Välkommen till Livslinjen!</h2>
                <p>Du är på väg att forma ett liv genom sex decennier i Sverige, från 1960-talet till 2010-talet. Dina val kommer att påverkas av samhällsförändringar, din bakgrund och dina personliga strävanden.</p>
                
                <h3>Så här fungerar spelet:</h3>
                <ul>
                    <li><strong>Karaktär:</strong> I början slumpas din karaktärs kön, födelseort och sociala bakgrund, vilket ger dig olika startförutsättningar. Du får också välja ett övergripande livsmål.</li>
                    <li><strong>Decennier:</strong> Spelet är indelat i decennier. För varje decennium åldras din karaktär 10 år och du ställs inför nya val och möjligheter. Historiska händelser specifika för decenniet kommer att presenteras och kan påverka ditt liv.</li>
                    <li><strong>Kapitalformer:</strong> Dina resurser är dina "kapital":
                        <ul>
                            <li><strong>Ekonomiskt:</strong> Pengar för att investera i projekt och boende. Tjänas genom arbete.</li>
                            <li><strong>Kulturellt:</strong> Kunskap, utbildning och erfarenheter. Öppnar dörrar till vissa utbildningar och yrken.</li>
                            <li><strong>Socialt:</strong> Nätverk, vänner och familjeband. Viktigt för relationer och vissa möjligheter.</li>
                            <li><strong>Symboliskt:</strong> Status, anseende och erkännande. Kan komma från karriär och samhällsengagemang.</li>
                            <li><strong>Tid (Ansträngning):</strong> Varje decennium har du 100 enheter "ansträngningstid" att fördela på olika projekt.</li>
                        </ul>
                    </li>
                    <li><strong>Projekt:</strong> Inom varje decennium väljer du projekt inom livets olika domäner: <strong>Utbildning, Arbete, Familj, Fritid,</strong> och <strong>Kulturellt engagemang</strong>.
                        <ul>
                            <li>Varje projekt har en <strong>varaktighet</strong> (1-10 år) som fyller din 10-åriga tidslinje för decenniet. Total varaktighet kan inte överstiga 10 år.</li>
                            <li>Projekt kostar också ansträngningstid och ofta andra kapitalformer, men ger i gengäld olika fördelar (mer kapital, bättre hälsa/lycka, nya möjligheter).</li>
                        </ul>
                    </li>
                    <li><strong>Hälsa & Lycka:</strong> Dessa två mätare (0-100) speglar ditt allmänna välbefinnande och påverkas av dina val, projekt och slumpmässiga händelser.</li>
                    <li><strong>Slumpmässiga Händelser:</strong> Livet är oförutsägbart! Positiva, negativa och neutrala händelser kan inträffa och påverka din situation.</li>
                    <li><strong>Mål:</strong> Försök att navigera livet på ett sätt som känns meningsfullt för dig, och se hur väl du uppnår ditt valda livsmål!</li>
                </ul>
                <p><strong>Kom ihåg:</strong> Det finns inga "rätta" eller "fel" val, bara olika livsvägar med olika konsekvenser. Lycka till!</p>
                <div class="controls">
                    <button class="btn btn-primary" onclick="showCharacterCreation()">Börja din resa</button>
                </div>
            </div>

            <div id="characterScreen" style="display: none;">
                <h2>Din karaktär genereras...</h2>
                <div id="characterInfo" class="character-info"></div>
                <div id="lifeGoalSelection" class="life-goal-selection">
                    <h3>Välj ditt övergripande livsmål:</h3>
                    <label><input type="radio" name="lifeGoal" value="happiness" checked> Maximal Lycka: Fokusera på välbefinnande och positiva upplevelser.</label>
                    <label><input type="radio" name="lifeGoal" value="wealth"> Ekonomisk Framgång: Sträva efter rikedom och materiell trygghet.</label>
                    <label><input type="radio" name="lifeGoal" value="family"> Stark Familj: Prioritera nära relationer och familjeliv.</label>
                    <label><input type="radio" name="lifeGoal" value="knowledge"> Kulturell Rikedom: Sök kunskap, utbildning och kulturella erfarenheter.</label>
                    <label><input type="radio" name="lifeGoal" value="status"> Högt Anseende: Arbeta för status, erkännande och inflytande.</label>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="confirmCharacterAndGoal()">Fortsätt till första decenniet</button>
                </div>
            </div>
            
            <div id="gameplayScreen" style="display: none;">
                <div id="decadeHeader" class="decade-header"></div>
                
                <div id="characterDisplay" class="character-info"></div>
                
                <div id="randomEventModal" class="modal">
                    <div class="modal-content">
                        <h3 id="randomEventTitle"></h3>
                        <p id="randomEventDescription"></p>
                        <button class="btn btn-primary" onclick="closeModal('randomEventModal')">Ok</button>
                    </div>
                </div>

                <div id="historicalEventsDisplay" class="historical-events"></div>
                
                <div class="timeline-container">
                    <h3>Din planering för detta decennium (10 år)</h3>
                    <p>Ansträngningstid använd: <span id="timeSpent">0</span> / <span id="totalTimePerDecade">100</span> enheter.</p>
                    <p>År planerade i decenniet: <span id="yearsFilled">0</span> / 10 år.</p>
                    <div id="timelineSlots" class="timeline-slots">
                        </div>
                    <div id="currentProjectsDisplay">
                        <p><em>Inga projekt valda än. Klicka på ett projekt nedan för att lägga till det.</em></p>
                    </div>
                </div>
                
                <div class="project-menu" id="projectMenu"></div>
                
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearCurrentDecadeProjects()">Rensa valda projekt</button>
                    <button class="btn btn-primary" onclick="completeDecade()">Slutför decennium</button>
                </div>
            </div>

            <div id="reflectionScreen" style="display: none;" class="reflection-screen">
                <h2>Reflektion över ditt decennium</h2>
                <div id="reflectionContent" class="decade-summary"></div>
                <div id="decadeEvents" class="random-event-display" style="display:none;"><h3>Händelser detta decennium:</h3><ul></ul></div>
                <div class="controls">
                    <button class="btn btn-primary" id="nextDecadeButton" onclick="nextDecade()">Nästa decennium</button>
                </div>
            </div>

            <div id="summaryScreen" style="display: none;" class="reflection-screen">
                <h2>Din livsresa - Sammanfattning</h2>
                <div id="lifeSummary" class="life-summary"></div>
                 <div id="finalStats" class="character-info"></div>
                 <div id="lifeGoalReflection" class="decade-summary"></div>
                <div class="controls">
                    <button class="btn btn-primary" onclick="restartGame()">Spela igen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {};
        const INITIAL_EFFORT_TIME_PER_DECADE = 100;
        const YEARS_PER_DECADE = 10;

        function getDefaultGameState() {
            return {
                character: null,
                currentDecadeIndex: 0,
                decades: ['1960-tal', '1970-tal', '1980-tal', '1990-tal', '2000-tal', '2010-tal'],
                age: 10, 
                currentDecadeProjects: [], 
                currentDecadeProjectDurations: [], // Store chosen project objects with their duration for timeline
                allCompletedProjects: [], 
                completedUniqueProjectIds: new Set(), // To track unique projects
                capital: {
                    economic: 0,
                    cultural: 0,
                    social: 0,
                    symbolic: 0,
                    time: INITIAL_EFFORT_TIME_PER_DECADE 
                },
                stats: { 
                    health: 80,
                    happiness: 60
                },
                constraints: { 
                    education_level: 'grundskola', 
                    hasJob: false,
                    isMarried: false,
                    hasFamily: false, 
                    hasChildren: false,
                    currentHousing: 'Hyr hos föräldrar/motsv.' // Starting housing
                },
                decadeLog: [] 
            };
        }

        const lifeGoalsData = {
            happiness: { name: "Maximal Lycka", description: "Fokusera på välbefinnande och positiva upplevelser.", bonus: { stats: { happiness: 0.1 } } }, // 10% bonus to happiness gains
            wealth: { name: "Ekonomisk Framgång", description: "Sträva efter rikedom och materiell trygghet.", bonus: { capital: { economic: 0.1 } } },
            family: { name: "Stark Familj", description: "Prioritera nära relationer och familjeliv.", bonus: { capital: { social: 0.1 } } }, // social capital gain towards family
            knowledge: { name: "Kulturell Rikedom", description: "Sök kunskap, utbildning och kulturella erfarenheter.", bonus: { capital: { cultural: 0.1 } } },
            status: { name: "Högt Anseende", description: "Arbeta för status, erkännande och inflytande.", bonus: { capital: { symbolic: 0.1 } } }
        };

        const swedishCities = [
             { name: 'Stockholm', weight: 25, region: 'Storstadsregion' },
            { name: 'Göteborg', weight: 15, region: 'Storstadsregion' },
            { name: 'Malmö', weight: 10, region: 'Storstadsregion' },
            { name: 'Uppsala', weight: 5, region: 'Mellanstor stad', type: 'universitetsstad' },
            { name: 'Lund', weight: 4, region: 'Mellanstor stad', type: 'universitetsstad' },
            { name: 'Linköping', weight: 4, region: 'Mellanstor stad', type: 'universitetsstad' },
            { name: 'Örebro', weight: 4, region: 'Mellanstor stad' },
            { name: 'Västerås', weight: 3, region: 'Mellanstor stad', type: 'industristad' },
            { name: 'Norrköping', weight: 3, region: 'Mellanstor stad', type: 'industristad' },
            { name: 'Kiruna', weight: 2, region: 'Småort', type: 'bruksort' },
            { name: 'Arvika', weight: 2, region: 'Småort' },
            { name: 'Landsbygd (Småland)', weight: 7, region: 'Landsbygd' },
            { name: 'Landsbygd (Norrland)', weight: 8, region: 'Landsbygd' },
            { name: 'Förort till storstad', weight: 8, region: 'Förort' }
        ];

        const socialClasses = [
            { name: 'Arbetarklass', weight: 45, initialCapital: { economic: 80, cultural: 15, social: 25, symbolic: 10 }, opportunitiesModifier: 0.85 }, // slightly increased starting eco
            { name: 'Medelklass', weight: 40, initialCapital: { economic: 180, cultural: 30, social: 35, symbolic: 15 }, opportunitiesModifier: 1.0 },
            { name: 'Övre medelklass/Akademiker', weight: 10, initialCapital: { economic: 250, cultural: 45, social: 40, symbolic: 25 }, opportunitiesModifier: 1.1 },
            { name: 'Överklass', weight: 5, initialCapital: { economic: 500, cultural: 60, social: 50, symbolic: 40 }, opportunitiesModifier: 1.25 }
        ];
        
        const historicalEventsData = { // Titles adjusted to be more descriptive of impact
            0: { // 1960-tal (ålder 10-19)
                title: 'Folkhemmets Expansion och Ungdomskultur',
                events: [
                    'Stark ekonomisk tillväxt skapar framtidstro och jobb.',
                    'Utbildningsreformer: Grundskolan införs, gymnasiet byggs ut.',
                    'Popmusik och ny ungdomskultur växer fram.',
                    'TV:n blir vanlig i hemmen och påverkar världsbilden.'
                ],
                modifiers: { capital_growth: { cultural: 0.05 }, general_optimism: 0.05} 
            },
            1: { // 1970-tal (ålder 20-29)
                title: 'Progg, Oljekris och Jämställdhetsdebatt',
                events: [
                    'Oljekrisen leder till ekonomisk osäkerhet och inflation.',
                    'Miljörörelsen och kärnkraftsdebatten engagerar.',
                    'Kvinnorörelsen kämpar för lika rättigheter, daghem byggs ut.',
                    'LAS (Lagen om anställningsskydd) införs 1974.'
                ],
                modifiers: { capital_change: { economic: -0.05, social: 0.05 }, job_security_increase: 0.05 } 
            },
            2: { // 1980-tal (ålder 30-39)
                title: 'Yuppies, IT-revolutionens början och Kalla Krigets slut',
                events: [
                    'Finansmarknaden avregleras, högkonjunktur och "yuppie-kultur".',
                    'Datorer och tidig IT börjar sippra in i arbetsliv och hem.',
                    'Palmemordet 1986 skakar Sverige.',
                    'Berlinmurens fall 1989 signalerar nya tider i Europa.'
                ],
                modifiers: { capital_growth: { economic: 0.1, symbolic: 0.05}, tech_opportunities: 0.05} 
            },
            3: { // 1990-tal (ålder 40-49)
                title: 'Ekonomisk Kris, EU-inträde och Internetbubblan',
                events: [
                    'Fastighets- och finanskris i början av decenniet, hög arbetslöshet.',
                    'Sverige går med i EU 1995 efter folkomröstning.',
                    'Internet och mobiltelefoner blir allt vanligare.',
                    'IT-bubblan växer sig stark mot slutet av decenniet.'
                ],
                modifiers: { capital_change: { economic: -0.1 }, unemployment_risk: 0.1, tech_bubble_effect: 0.05 } 
            },
            4: { // 2000-tal (ålder 50-59)
                title: 'Globalisering, IT-krasch och Millennieskifte',
                events: [
                    'IT-bubblan spricker, men digitaliseringen fortsätter.',
                    'Terrorattackerna 11 september 2001 påverkar världsläget.',
                    'Globaliseringen tilltar med ökad handel och rörlighet.',
                    'Fastighetspriserna börjar stiga kraftigt.'
                ],
                modifiers: { capital_volatility: { economic: 0.05 }, cultural_capital_value_increase: 0.05 }
            },
            5: { // 2010-tal (ålder 60-69)
                title: 'Sociala Medier, Klimatfokus och Ökad Polarisering',
                events: [
                    'Sociala medier blir en dominerande kraft i kommunikation och opinion.',
                    'Klimatförändringarna blir en allt hetare fråga.',
                    'Finanskrisens efterdyningar och ökad politisk polarisering.',
                    'Flyktingkrisen 2015 utmanar samhället.'
                ],
                modifiers: { capital_change: { social: (gs) => gs.character.lifeGoal === 'family' ? 0.03 : -0.03 }, tech_impact_social: 0.1 } // Social capital affected differently
            }
        };
        
        // --- PROJECT CATEGORIES AND PROJECTS ---
        // Updated project structure:
        // unique: true (if project can only be done once)
        // duration: years it takes on the timeline (1-10)
        // costs: { economic: X, time: Y (effort units), cultural: Z ... }
        // requirements: { age_min, age_max, capital_min: {type: val}, education_level, constraints_is: {key:val}, prerequisite_project: "project_id" }
        // benefits: { capital: {type:val}, stats: {type:val} }
        // outcomes: { constraints: {key:val}, education_level: "level" }
        // category: links back to the top-level category key for color, etc.

        const projectData = {
            // UTBILDNING
            edu_grundskola_avslutad: { id: 'edu_grundskola_avslutad', name: "Avsluta Grundskolan", category: "Utbildning", duration: 0, costs: {}, requirements: { age_min: 15}, benefits: { capital: { cultural: 10 } }, outcomes: { education_level: "grundskola_avslutad" }, description: "Grundläggande obligatorisk utbildning.", unique: true, auto_assign_age: 15 },
            edu_gymnasium: { id: 'edu_gymnasium', name: 'Gymnasieutbildning', category: "Utbildning", duration: 3, costs: { economic: 10, time: 35 }, requirements: { age_min: 15, age_max: 22, education_level: "grundskola_avslutad" }, benefits: { capital: { cultural: 35, social: 5 }, stats: { happiness: 5 } }, outcomes: { education_level: 'gymnasium' }, description: 'Högskoleförberedande eller yrkesinriktad utbildning.', unique: true },
            edu_universitet_grund: { id: 'edu_universitet_grund', name: 'Universitetsstudier (Kandidat)', category: "Utbildning", duration: 3, costs: { economic: 40, time: 45, cultural: -5 }, requirements: { age_min: 18, education_level: 'gymnasium', capital_min: {cultural: 30} }, benefits: { capital: { cultural: 50, social: 10, symbolic: 15 }, stats: { happiness: 5 } }, outcomes: { education_level: 'högskola_kandidat' }, description: 'Grundläggande akademisk examen (t.ex. Kandidatexamen).', unique: true },
            edu_universitet_avancerad: { id: 'edu_universitet_avancerad', name: 'Universitetsstudier (Master/Magister)', category: "Utbildning", duration: 2, costs: { economic: 30, time: 40, cultural: -10 }, requirements: { age_min: 20, education_level: 'högskola_kandidat', capital_min: {cultural: 60} }, benefits: { capital: { cultural: 35, symbolic: 20 }, stats: { happiness: 5 } }, outcomes: { education_level: 'högskola_master' }, description: 'Fördjupade akademiska studier.', unique: true },
            edu_yrkeshogskola: { id: 'edu_yrkeshogskola', name: 'Yrkeshögskola/KY-utbildning', category: "Utbildning", duration: 2, costs: { economic: 20, time: 30 }, requirements: { age_min: 18, education_level: ['gymnasium', 'grundskola_avslutad'] }, benefits: { capital: { cultural: 25, social: 5 }, stats: { career_prospects: 15 } }, outcomes: { education_level: 'yrkeshögskola' }, description: 'Praktisk, yrkesinriktad högre utbildning.', unique: true },
            edu_folkhogskola: { id: 'edu_folkhogskola', name: 'Folkhögskola (Allmän kurs/Profilkurs)', category: "Utbildning", duration: 1, costs: { economic: 10, time: 20 }, requirements: { age_min: 18 }, benefits: { capital: { cultural: 20, social: 10 }, stats: { happiness: 10 } }, outcomes: { education_level: 'folkhögskola' }, description: 'Bildning och personlig utveckling, kan ge behörighet.', }, // Kan göras flera gånger med olika inriktning
            edu_komvux: { id: 'edu_komvux', name: 'Komvux/Vuxenutbildning', category: "Utbildning", duration: 1, costs: { economic: 5, time: 15 }, requirements: { age_min: 20 }, benefits: { capital: { cultural: 15 } }, outcomes: {}, description: 'Komplettera betyg eller läs nya kurser som vuxen.' },

            // ARBETE
            work_sommarjobb: { id: 'work_sommarjobb', name: 'Sommarjobb/Extrajobb', category: "Arbete", duration: 0, costs: { time: 15 }, requirements: { age_min: 15, age_max: 25 }, benefits: { capital: { economic: 20, social: 5 }, stats: { career_prospects: 5 } }, outcomes: {}, description: 'Tjäna extra pengar och få arbetslivserfarenhet.' }, // Duration 0 means it's a short-term project within a year
            work_enkelt_heltid: { id: 'work_enkelt_heltid', name: 'Enklare Heltidsarbete', category: "Arbete", duration: 5, costs: { time: 50 }, requirements: { age_min: 18, education_level: ['grundskola_avslutad', 'gymnasium', 'folkhögskola'] }, benefits: { capital: { economic: 120, social: 5 }, stats: { health: -5 } }, outcomes: { constraints: { hasJob: true } }, description: 'Stabilt men kanske slitsamt arbete utan större krav på utbildning.' },
            work_kvalificerat: { id: 'work_kvalificerat', name: 'Kvalificerat Arbete', category: "Arbete", duration: 8, costs: { time: 60 }, requirements: { age_min: 22, education_level: ['gymnasium', 'yrkeshögskola', 'högskola_kandidat'] }, benefits: { capital: { economic: 200, symbolic: 10 }, stats: { career_prospects: 20 } }, outcomes: { constraints: { hasJob: true } }, description: 'Anställning som kräver viss utbildning eller erfarenhet.' },
            work_specialist_chef: { id: 'work_specialist_chef', name: 'Specialist-/Chefsposition', category: "Arbete", duration: 10, costs: { time: 70, social: -5 }, requirements: { age_min: 30, education_level: ['högskola_kandidat', 'högskola_master'], capital_min: {cultural: 70, social: 40, symbolic: 20} }, benefits: { capital: { economic: 350, symbolic: 30 }, stats: { happiness: -5, health: -10, career_prospects: 30 } }, outcomes: { constraints: { hasJob: true } }, description: 'Ansvarsfullt och välbetalt, men ofta krävande.' },
            work_eget_foretag: { id: 'work_eget_foretag', name: 'Starta Eget Företag', category: "Arbete", duration: 6, costs: { economic: 100, time: 75, social: -10 }, requirements: { age_min: 25, capital_min:{ economic: 80, cultural: 30 } }, benefits: { capital: { economic: 250, symbolic: 25 }, stats: { happiness: 10, health: -10 } }, outcomes: { constraints: { hasJob: true } }, description: 'Riskfyllt men med chans till stor frihet och förtjänst.' },
            work_gig_frilans: { id: 'work_gig_frilans', name: 'Gig-arbete/Frilans', category: "Arbete", duration: 4, costs: { time: 40 }, requirements: { age_min: 20 }, benefits: { capital: { economic: 100 }, stats: { happiness: 5, career_prospects: 10 } }, outcomes: { constraints: { hasJob: true } }, description: 'Flexibelt men ofta osäkert, projektbaserat arbete.' },
            
            // FAMILJ
            family_partner: { id: 'family_partner', name: 'Skaffa Fast Partner', category: "Familj", duration: 1, costs: { time: 20, economic: 10 }, requirements: { age_min: 18, capital_min: { social: 20 } }, benefits: { stats: { happiness: 20, health: 5 }, capital: { social: 15 } }, outcomes: { constraints: { hasFamily: true } }, description: 'Inled en seriös och varaktig relation.' },
            family_sambo_gifta: { id: 'family_sambo_gifta', name: 'Bli Sambo/Gifta Sig', category: "Familj", duration: 1, costs: { economic: 40, time: 10 }, requirements: { age_min: 20, constraints_is: { hasFamily: true } }, benefits: { stats: { happiness: 15 }, capital: { social: 10, symbolic: 10 } }, outcomes: { constraints: { isMarried: true } }, description: 'Formalisera förhållandet och flytta ihop.', unique: true },
            family_barn: { id: 'family_barn', name: 'Skaffa Barn', category: "Familj", duration: 5, costs: { economic: 100, time: 50, happiness: -15 }, requirements: { age_min: 22, age_max: 45, constraints_is: { hasFamily: true } }, benefits: { stats: { happiness: 40 }, capital: { social: 20, symbolic: 5 } }, outcomes: { constraints: { hasChildren: true } }, description: 'Utöka familjen. En stor omställning och glädje.' }, // Kan göras flera gånger, men effekten kanske minskar?
            family_husdjur: { id: 'family_husdjur', name: 'Skaffa Husdjur', category: "Familj", duration: 0, costs: {economic: 15, time: 10}, requirements: { age_min: 16 }, benefits: { stats: {happiness: 10, health: 5}, capital: {social: 5}}, description: "En fyrbent (eller annan) vän i familjen."},
            family_boende_hyresratt: { id: 'family_boende_hyresratt', name: 'Flytta till Hyresrätt', category: "Familj", duration: 0, costs: { economic: 30 }, requirements: { age_min: 18 }, benefits: { stats: { happiness: 5 } }, outcomes: { constraints: { currentHousing: "Hyresrätt" } }, description: 'Skaffa eget boende, flexibelt men ingen investering.'},
            family_boende_bostadsratt: { id: 'family_boende_bostadsratt', name: 'Köpa Bostadsrätt', category: "Familj", duration: 1, costs: { economic: 180, time: 10 }, requirements: { age_min: 23, constraints_is: {hasJob: true}, capital_min: {economic: 100} }, benefits: { capital: { economic: 20, symbolic: 15 }, stats: { happiness: 10 } }, outcomes: { constraints: { currentHousing: "Bostadsrätt" } }, description: 'Investera i ett eget hem.', unique: true},
            family_boende_villa: { id: 'family_boende_villa', name: 'Köpa Villa/Radhus', category: "Familj", duration: 2, costs: { economic: 300, time: 20 }, requirements: { age_min: 28, constraints_is: {hasJob: true, hasFamily: true}, capital_min: {economic: 200} }, benefits: { capital: { economic: 40, symbolic: 25 }, stats: { happiness: 15 } }, outcomes: { constraints: { currentHousing: "Villa/Radhus" } }, description: 'Det stora familjeboendet.', unique: true},

            // FRITID
            fritid_traning: { id: 'fritid_traning', name: 'Regelbunden Träning', category: "Fritid", duration: 0, costs: { economic: 10, time: 15 }, requirements: {}, benefits: { stats: { health: 20, happiness: 10 } }, blocked_by_if: { hasChildren: { time_cost_increase_factor: 1.5, effort_time_cost_increase_factor: 1.3 } }, description: 'Håll dig aktiv för bättre hälsa och välmående.' },
            fritid_hobby: { id: 'fritid_hobby', name: 'Intensiv Hobbyverksamhet', category: "Fritid", duration: 0, costs: { economic: 20, time: 15 }, requirements: {}, benefits: { stats: { happiness: 15 }, capital: { cultural: 10, social: 5 } }, reduced_by_if: { hasFamily: { time_cost_increase_factor: 1.2, effort_time_cost_increase_factor: 1.2 } }, description: 'Odla ett djupt intresse, t.ex. musik, konst, idrott.' },
            fritid_resa_utomlands: { id: 'fritid_resa_utomlands', name: 'Stor Resa Utomlands', category: "Fritid", duration: 0, costs: { economic: 100, time: 10 }, requirements: { capital_min:{ economic: 80 } }, benefits: { stats: { happiness: 25 }, capital: { cultural: 15 } }, blocked_by_if: { hasChildren: { probability_decrease_factor: 0.6 } }, description: 'Upptäck världen och vidga dina vyer (1-2 månader).' },
            fritid_personlig_utveckling: { id: 'fritid_personlig_utveckling', name: 'Kurs i Personlig Utveckling', category: "Fritid", duration: 0, costs: { economic: 50, time: 10 }, requirements: {}, benefits: { stats: { happiness: 15, health: 5 }, capital: {cultural: 5} }, description: 'Investera i dig själv (t.ex. mindfulness, ledarskap, terapi).' },
            fritid_vanner: { id: 'fritid_vanner', name: 'Underhålla Vänskapsrelationer', category: "Fritid", duration: 0, costs: { time: 15, economic: 10 }, requirements: {}, benefits: { stats: { happiness: 15 }, capital: { social: 20 } }, description: 'Investera tid i dina vänner och sociala nätverk.'},

            // KULTURELLT ENGAGEMANG
            kultur_forening: { id: 'kultur_forening', name: 'Engagemang i Förening', category: "Kulturellt engagemang", duration: 2, costs: { time: 15, economic: 5 }, requirements: {}, benefits: { capital: { social: 15, cultural: 5, symbolic: 5 }, stats: { happiness: 10 } }, description: 'Delta aktivt i en idrottsförening, kulturförening, eller intresseorganisation.' },
            kultur_politik: { id: 'kultur_politik', name: 'Politiskt Engagemang (Lokalt)', category: "Kulturellt engagemang", duration: 3, costs: { time: 20 }, requirements: { capital_min: { cultural: 20 } }, benefits: { capital: { social: 10, symbolic: 15 }, stats: { happiness: 5 } }, description: 'Bli aktiv i ett politiskt parti eller en intresseorganisation på lokal nivå.' },
            kultur_volontar: { id: 'kultur_volontar', name: 'Volontärarbete', category: "Kulturellt engagemang", duration: 1, costs: { time: 15 }, requirements: {}, benefits: { capital: { social: 15, symbolic: 5 }, stats: { happiness: 15 } }, description: 'Gör en ideell insats för ett gott ändamål.' },
            kultur_konsumtion: { id: 'kultur_konsumtion', name: 'Regelbunden Kulturkonsumtion', category: "Kulturellt engagemang", duration: 0, costs: { economic: 20, time: 10 }, requirements: {}, benefits: { capital: { cultural: 15 }, stats: { happiness: 10 } }, description: 'Besök ofta teatrar, konserter, museer, läs böcker.' },
        };
        
        const projectCategories = {
            "Utbildning": { color: '#007bff', projects: [] },
            "Arbete": { color: '#28a745', projects: [] },
            "Familj": { color: '#dc3545', projects: [] },
            "Fritid": { color: '#6f42c1', projects: [] },
            "Kulturellt engagemang": { color: '#20c997', projects: [] }
        };

        // Populate categories from projectData
        for (const projectId in projectData) {
            const project = projectData[projectId];
            if (projectCategories[project.category]) {
                projectCategories[project.category].projects.push(project);
            }
        }


        const randomEventTypes = { // Probabilities are per decade
            positive: [
                { title: 'Oväntat arv', description: 'En avlägsen släkting har testamenterat en summa pengar till dig.', effects: { capital: { economic: 100 }, stats: { happiness: 10 } }, probability: 0.04, class_modifier: { 'Överklass': 1.8, 'Arbetarklass': 0.7 } },
                { title: 'Vinn på Trisslott', description: 'Plötsligt händer det! En mindre summa pengar.', effects: { capital: { economic: 30 }, stats: { happiness: 5 } }, probability: 0.05 },
                { title: 'Ny Vänskap För Livet', description: 'Du träffar någon som blir en ovärderlig vän och stöttepelare.', effects: { capital: { social: 20 }, stats: { happiness: 15 } }, probability: 0.08 },
                { title: 'Befordran på Jobbet', description: 'Ditt hårda arbete lönar sig, du erbjuds en bättre position.', effects: { capital: { economic: 50, symbolic: 15 }, stats: { career_prospects: 10 } }, probability: 0.05, requirements: { constraints_is: { hasJob: true } } },
                { title: 'Inspirerande Kulturupplevelse', description: 'En bok, film eller konsert berör dig djupt och vidgar dina vyer.', effects: { capital: { cultural: 10 }, stats: { happiness: 5 } }, probability: 0.07 }
            ],
            negative: [
                { title: 'Långvarig Sjukdom', description: 'Du drabbas av en sjukdom som påverkar dig under en längre tid.', effects: { stats: { health: -20, happiness: -15 }, capital: { economic: -30, time: -15 } }, probability: 0.05 },
                { title: 'Arbetslöshet', description: 'Företaget skär ner och du blir tyvärr uppsagd.', effects: { capital: { career_prospects: -10, economic: -50 }, stats: { happiness: -20 }, outcomes: { constraints: { hasJob: false } } }, probability: 0.04, requirements: { constraints_is: { hasJob: true } }, class_modifier: { 'Arbetarklass': 1.3, 'Övre medelklass/Akademiker': 0.8 } },
                { title: 'Relationsproblem', description: 'En nära relation knakar i fogarna, vilket orsakar stress.', effects: { stats: { happiness: -15 }, capital: { social: -10 } }, probability: 0.07, requirements: { constraints_is: { hasFamily: true } } },
                { title: 'Ekonomisk Stöld/Förlust', description: 'Du råkar ut för en stöld eller en oväntad ekonomisk förlust.', effects: { capital: { economic: -60 }, stats: { happiness: -10 } }, probability: 0.03 },
                { title: 'Utbrändhet', description: 'Stress och höga krav leder till att du känner dig helt slutkörd.', effects: { stats: { health: -15, happiness: -10 }, capital: { time: -20 } }, probability: 0.05, requirements: { constraints_is: { hasJob: true } } }
            ],
            neutral: [ // Often lead to choices or minor shifts
                { title: 'Flyttmöjlighet', description: 'En möjlighet att flytta till en annan del av landet dyker upp.', effects: { capital: { social: -5 } }, probability: 0.06 }, // Could trigger a choice event
                { title: 'Nytt Samhällsintresse', description: 'En aktuell samhällsfråga eller ny hobby fångar ditt intresse.', effects: { capital: { cultural: 5 } }, probability: 0.08 },
                { title: 'Teknologisk Skifte', description: 'Ny teknik förändrar hur du arbetar eller lever din vardag.', effects: { capital: { cultural: 5 } }, probability: 0.07, decade_modifier: { 2: 1.2, 3: 1.5, 4: 1.8, 5: 2.0 } }
            ]
        };

        // --- UI HELPER FUNCTIONS ---
        function showScreen(screenId) {
            ['introScreen', 'characterScreen', 'gameplayScreen', 'reflectionScreen', 'summaryScreen'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });
            if (document.getElementById(screenId)) {
                document.getElementById(screenId).style.display = 'block';
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showModal(modalId, title, description) {
            document.getElementById(modalId).style.display = 'flex'; // Use flex for centering
            if (title) document.getElementById(modalId.replace('Modal', 'Title')).innerText = title;
            if (description) document.getElementById(modalId.replace('Modal', 'Description')).innerText = description;
        }

        // --- CHARACTER CREATION ---
        function weightedRandom(items) {
            let totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            for (let item of items) {
                if (randomNum < item.weight) return item;
                randomNum -= item.weight;
            }
            return items[items.length - 1];
        }
        
        function showCharacterCreation() {
            gameState = getDefaultGameState(); // Initialize/reset gameState
            const gender = Math.random() < 0.5 ? 'Kvinna' : 'Man';
            const birthplace = weightedRandom(swedishCities);
            const socialClass = weightedRandom(socialClasses);

            gameState.character = {
                gender: gender,
                birthplace: birthplace.name,
                socialClass: socialClass.name,
                region: birthplace.region,
                opportunitiesModifier: socialClass.opportunitiesModifier,
                classDetails: socialClass,
                lifeGoal: null // To be set by player
            };

            Object.assign(gameState.capital, socialClass.initialCapital);
            gameState.capital.time = INITIAL_EFFORT_TIME_PER_DECADE;

            const infoDiv = document.getElementById('characterInfo');
            infoDiv.innerHTML = `
                <h3>Din start i livet (Ålder: ${gameState.age}):</h3>
                <p><strong>Kön:</strong> ${gameState.character.gender}</p>
                <p><strong>Födelseort:</strong> ${gameState.character.birthplace} (${gameState.character.region})</p>
                <p><strong>Social bakgrund:</strong> ${gameState.character.socialClass}</p>
                <div class="character-stats">
                    <div class="stat-item"><strong>Ekonomiskt:</strong> ${gameState.capital.economic}</div>
                    <div class="stat-item"><strong>Kulturellt:</strong> ${gameState.capital.cultural}</div>
                    <div class="stat-item"><strong>Socialt:</strong> ${gameState.capital.social}</div>
                    <div class="stat-item"><strong>Symboliskt:</strong> ${gameState.capital.symbolic}</div>
                </div>
            `;
            showScreen('characterScreen');
        }

        function confirmCharacterAndGoal() {
            const selectedGoal = document.querySelector('input[name="lifeGoal"]:checked');
            if (selectedGoal) {
                gameState.character.lifeGoal = selectedGoal.value;
            } else {
                // Default goal if none selected, though radio buttons usually have a default checked
                gameState.character.lifeGoal = 'happiness'; 
            }
            startFirstDecade();
        }


        // --- GAME FLOW ---
        function restartGame() {
            showScreen('introScreen'); // Will reset gameState when "Börja din resa" is clicked
        }

        function startFirstDecade() {
            gameState.currentDecadeIndex = 0;
            // Auto-assign grundskola if character is of age, this is a simplification
            const grundskola = projectData.edu_grundskola_avslutad;
            if (gameState.age >= grundskola.requirements.age_min && !gameState.completedUniqueProjectIds.has(grundskola.id)) {
                applyProjectEffects(grundskola, gameState.decadeLog[0] = { projects: [], events: [] }); // Apply its effects directly
                gameState.completedUniqueProjectIds.add(grundskola.id);
                gameState.allCompletedProjects.push({name: grundskola.name, decade: -1}); // Mark as pre-game
            }
            setupDecade();
        }
        
        function setupDecade() {
            gameState.age += 10; 
            gameState.capital.time = INITIAL_EFFORT_TIME_PER_DECADE; 
            gameState.currentDecadeProjects = []; 
            gameState.currentDecadeProjectDurations = [];
            if (!gameState.decadeLog[gameState.currentDecadeIndex]) {
                 gameState.decadeLog[gameState.currentDecadeIndex] = { projects: [], events: [] };
            }

            document.getElementById('decadeHeader').innerHTML = `
                <h2>${gameState.decades[gameState.currentDecadeIndex]} (Ålder: ${gameState.age}-${gameState.age+9})</h2>
                <p>Planera dina kommande 10 år. Ditt livsmål: ${lifeGoalsData[gameState.character.lifeGoal]?.name || 'Inget valt'}</p>
            `;
            updateCharacterDisplay();
            renderHistoricalEvents();
            renderProjects();
            renderTimelineSlots(); // Initial render of empty slots
            updateCurrentProjectsListDisplay(); 
            
            triggerRandomEvents();
            showScreen('gameplayScreen');
        }

        function nextDecade() {
            gameState.currentDecadeIndex++;
            if (gameState.currentDecadeIndex < gameState.decades.length) {
                setupDecade();
            } else {
                showFinalSummary();
            }
        }
        
        function updateCharacterDisplay() {
            const displayDiv = document.getElementById('characterDisplay');
            let capitalHTML = '<div class="character-stats">';
            for (const [key, value] of Object.entries(gameState.capital)) {
                capitalHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${Math.round(value)}</div>`;
            }
            capitalHTML += '</div>';

            let statsHTML = '<div class="character-stats" style="margin-top:10px;">';
             for (const [key, value] of Object.entries(gameState.stats)) {
                statsHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${Math.round(value)}</div>`;
            }
            statsHTML += '</div>';

            let constraintsHTML = '<div style="margin-top:10px; font-size:0.9em;"><strong>Nuvarande status:</strong> ';
            constraintsHTML += `Utbildning: ${gameState.constraints.education_level.replace("_", " ")}, `;
            constraintsHTML += `Jobb: ${gameState.constraints.hasJob ? 'Ja' : 'Nej'}, `;
            constraintsHTML += `Gift/Sambo: ${gameState.constraints.isMarried ? 'Ja' : 'Nej'}, `;
            constraintsHTML += `Barn: ${gameState.constraints.hasChildren ? 'Ja' : 'Nej'}, `;
            constraintsHTML += `Boende: ${gameState.constraints.currentHousing}`;
            constraintsHTML += '</div>';

            displayDiv.innerHTML = `
                <h3>Din status (Ålder: ${gameState.age})</h3>
                <p><strong>Klass:</strong> ${gameState.character.socialClass}, <strong>Kön:</strong> ${gameState.character.gender}</p>
                <h4>Kapital:</h4>
                ${capitalHTML}
                <h4>Livskvalitet:</h4>
                ${statsHTML}
                ${constraintsHTML}
            `;
            const totalEffortTimeSpent = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + getAdjustedProjectCost(p.project, 'time'), 0);
            document.getElementById('timeSpent').innerText = totalEffortTimeSpent;
            document.getElementById('totalTimePerDecade').innerText = INITIAL_EFFORT_TIME_PER_DECADE;

            const totalYearsFilled = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + p.project.duration, 0);
            document.getElementById('yearsFilled').innerText = totalYearsFilled;
        }

        function renderHistoricalEvents() {
            const eventsContainer = document.getElementById('historicalEventsDisplay');
            const decadeEventsData = historicalEventsData[gameState.currentDecadeIndex];
            if (decadeEventsData) {
                let html = `<h3>Samhällsklimat och Händelser: ${decadeEventsData.title}</h3><ul>`;
                decadeEventsData.events.forEach(eventText => {
                    html += `<li>${eventText}</li>`;
                });
                html += `</ul>`;
                // Optionally display modifiers if desired:
                // if(decadeEventsData.modifiers) html += `<small>Påverkan: ${JSON.stringify(decadeEventsData.modifiers)}</small>`;
                eventsContainer.innerHTML = html;
                eventsContainer.style.display = 'block';
            } else {
                eventsContainer.style.display = 'none';
            }
        }

        // --- TIMELINE & PROJECT HANDLING ---
        function renderTimelineSlots() {
            const slotsContainer = document.getElementById('timelineSlots');
            slotsContainer.innerHTML = ''; // Clear existing slots
            let currentYear = 0;
            
            gameState.currentDecadeProjectDurations.forEach(item => {
                for (let y = 0; y < item.project.duration; y++) {
                    if (currentYear < YEARS_PER_DECADE) {
                        const slotDiv = document.createElement('div');
                        slotDiv.className = 'timeline-slot project-year';
                        slotDiv.style.backgroundColor = projectCategories[item.project.category]?.color || '#ccc';
                        slotDiv.style.flexGrow = 1; // Make projects take up proportional space if fewer than 10 years
                        slotDiv.textContent = `${item.project.name.substring(0,10)}... (År ${y+1})`;
                        slotDiv.title = `${item.project.name} (År ${y+1} av ${item.project.duration})`;
                        slotsContainer.appendChild(slotDiv);
                        currentYear++;
                    }
                }
            });

            // Fill remaining years with empty slots
            for (let y = currentYear; y < YEARS_PER_DECADE; y++) {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'timeline-slot';
                slotDiv.style.flexGrow = 1;
                slotDiv.textContent = `År ${y + 1} Ledigt`;
                slotsContainer.appendChild(slotDiv);
            }
        }
        
        function meetsRequirements(project) {
            // Age requirement
            if (project.requirements.age_min && gameState.age < project.requirements.age_min) return false;
            if (project.requirements.age_max && gameState.age > project.requirements.age_max) return false;
            
            // Unique project check
            if (project.unique && gameState.completedUniqueProjectIds.has(project.id)) return false;

            // Capital requirements
            if (project.requirements.capital_min) {
                for (const cap_type in project.requirements.capital_min) {
                    if (gameState.capital[cap_type] < project.requirements.capital_min[cap_type]) return false;
                }
            }
            
            // Education level requirement
            if (project.requirements.education_level) {
                const currentLevel = gameState.constraints.education_level;
                const requiredLevels = Array.isArray(project.requirements.education_level) ? project.requirements.education_level : [project.requirements.education_level];
                
                const eduHierarchy = ['ingen', 'grundskola', 'grundskola_avslutad', 'folkhögskola', 'gymnasium', 'yrkeshögskola', 'högskola_kandidat', 'högskola_master'];
                let currentIdx = eduHierarchy.indexOf(currentLevel);
                let meetsEduReq = false;
                for(const reqLevel of requiredLevels){
                    if (eduHierarchy.indexOf(reqLevel) <= currentIdx) {
                        meetsEduReq = true;
                        break;
                    }
                }
                if(!meetsEduReq) return false;
            }
            
            // Constraint requirements (e.g., must be married, must have job)
            if (project.requirements.constraints_is) {
                for (const key in project.requirements.constraints_is) {
                    if (gameState.constraints[key] !== project.requirements.constraints_is[key]) return false;
                }
            }
            // Prerequisite project
            if (project.requirements.prerequisite_project && !gameState.completedUniqueProjectIds.has(project.requirements.prerequisite_project)) return false;


            // Check blocked_by_if conditions
            if (project.blocked_by_if) {
                for (const constraintKey in project.blocked_by_if) {
                    if (gameState.constraints[constraintKey]) { 
                        const blockCondition = project.blocked_by_if[constraintKey];
                        if (blockCondition.probability_decrease_factor) { 
                             if (Math.random() < blockCondition.probability_decrease_factor && project.id !== "fritid_resa_utomlands") { // Specific hack for travel, better to make this generic
                                 // console.log(`Project ${project.name} blocked by ${constraintKey} due to probability.`);
                                 return false; 
                             }
                        } else if (typeof blockCondition === 'boolean' && blockCondition) { // simple boolean block
                            // console.log(`Project ${project.name} hard blocked by ${constraintKey}.`);
                            return false; 
                        }
                         // Cost increase factors are handled in getAdjustedProjectCost
                    }
                }
            }
            return true;
        }
        
        function getAdjustedProjectCost(project, costType) {
            let baseCost = project.costs[costType] || 0;
            let costKeySuffix = costType === 'time' ? 'effort_time_cost_increase_factor' : `${costType}_cost_increase_factor`;

            if (project.blocked_by_if) { // Check "blocked_by_if" for cost increases (often used for leisure when having children)
                 for (const constraintKey in project.blocked_by_if) {
                    if (gameState.constraints[constraintKey]) {
                        const condition = project.blocked_by_if[constraintKey];
                        if (condition[costKeySuffix]) {
                             baseCost *= condition[costKeySuffix];
                        }
                    }
                }
            }
            if (project.reduced_by_if) { // Check "reduced_by_if" for cost increases
                 for (const constraintKey in project.reduced_by_if) {
                    if (gameState.constraints[constraintKey]) {
                        const condition = project.reduced_by_if[constraintKey];
                         if (condition[costKeySuffix]) {
                             baseCost *= condition[costKeySuffix];
                        }
                    }
                }
            }
            return Math.round(baseCost);
        }


        function renderProjects() {
            const menuDiv = document.getElementById('projectMenu');
            menuDiv.innerHTML = '';
            const totalEffortTimeSpent = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + getAdjustedProjectCost(p.project, 'time'), 0);
            const totalYearsFilled = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + p.project.duration, 0);

            for (const categoryName in projectCategories) {
                const category = projectCategories[categoryName];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'project-category';
                categoryDiv.innerHTML = `<h4>${categoryName}</h4>`;

                category.projects.forEach(project => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'project-item';
                    
                    const actualEffortTimeCost = getAdjustedProjectCost(project, 'time');
                    const actualEconomicCost = getAdjustedProjectCost(project, 'economic');

                    let titleText = `${project.name}`;
                    if (project.duration > 0) titleText += ` (${project.duration} år)`;
                    
                    let costText = `Anstr.: ${actualEffortTimeCost}`;
                    if (actualEconomicCost !== 0) costText += `, Eko: ${actualEconomicCost}`;
                    
                    itemDiv.innerHTML = `${titleText}<small>${project.description}<br><strong>Kostnad:</strong> ${costText}</small>`;
                    
                    const canAffordEffortTime = (totalEffortTimeSpent + actualEffortTimeCost) <= INITIAL_EFFORT_TIME_PER_DECADE;
                    const canAffordYears = (totalYearsFilled + project.duration) <= YEARS_PER_DECADE;
                    const canAffordEconomic = gameState.capital.economic >= (actualEconomicCost > 0 ? actualEconomicCost : 0) ;
                    
                    if (meetsRequirements(project) && canAffordEffortTime && canAffordYears && canAffordEconomic) {
                        itemDiv.onclick = () => selectProject(project);
                    } else {
                        itemDiv.classList.add('disabled');
                        let reason = [];
                        if (project.unique && gameState.completedUniqueProjectIds.has(project.id)) reason.push("Redan slutfört.");
                        else if (!meetsRequirements(project)) reason.push("Krav ej uppfyllda.");
                        if (!canAffordYears && project.duration > 0) reason.push("Inte tillräckligt med år kvar i decenniet.");
                        if (!canAffordEffortTime) reason.push("Inte tillräckligt med ansträngningstid.");
                        if (!canAffordEconomic) reason.push("Inte tillräckligt med ekonomiskt kapital.");
                        itemDiv.title = reason.join(" ").trim() || "Kan inte väljas just nu.";
                    }
                    categoryDiv.appendChild(itemDiv);
                });
                menuDiv.appendChild(categoryDiv);
            }
        }
        
        function selectProject(project) {
            const actualEffortTimeCost = getAdjustedProjectCost(project, 'time');
            const actualEconomicCost = getAdjustedProjectCost(project, 'economic');
            const totalEffortTimeSpent = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + getAdjustedProjectCost(p.project, 'time'), 0);
            const totalYearsFilled = gameState.currentDecadeProjectDurations.reduce((sum, p) => sum + p.project.duration, 0);

            if ((totalYearsFilled + project.duration) > YEARS_PER_DECADE && project.duration > 0) {
                showModal('randomEventModal', 'För få år kvar', 'Detta projekt får inte plats inom decenniets 10 år med nuvarande planering.');
                return;
            }
            if ((totalEffortTimeSpent + actualEffortTimeCost) > INITIAL_EFFORT_TIME_PER_DECADE) {
                showModal('randomEventModal', 'För lite ansträngningstid', 'Du har inte tillräckligt med ansträngningstid kvar för detta projekt.');
                return;
            }
            if (gameState.capital.economic < (actualEconomicCost > 0 ? actualEconomicCost : 0)) {
                 showModal('randomEventModal', 'För lite pengar', 'Du har inte råd med detta projekt.');
                return;
            }

            if (actualEconomicCost !== 0) { // Handles both positive cost and negative (income)
                gameState.capital.economic -= actualEconomicCost;
            }

            gameState.currentDecadeProjectDurations.push({ project: project, duration: project.duration });
            
            updateCharacterDisplay();
            renderProjects(); 
            renderTimelineSlots();
            updateCurrentProjectsListDisplay();
        }

        function updateCurrentProjectsListDisplay() { // Renamed for clarity
            const display = document.getElementById('currentProjectsDisplay');
            if (gameState.currentDecadeProjectDurations.length === 0) {
                display.innerHTML = '<p><em>Inga projekt valda än. Klicka på ett projekt ovan för att lägga till det.</em></p>';
                return;
            }
            display.innerHTML = '<h4>Valda projekt detta decennium:</h4>';
            gameState.currentDecadeProjectDurations.forEach(item => {
                const p = item.project;
                const pDiv = document.createElement('div');
                pDiv.classList.add('project-entry');
                pDiv.style.backgroundColor = projectCategories[p.category]?.color || '#ccc';
                let text = `${p.name}`;
                if (p.duration > 0) text += ` (${p.duration} år)`;
                text += ` (Anstr: ${getAdjustedProjectCost(p, 'time')}${p.costs.economic ? ', Eko: ' + getAdjustedProjectCost(p, 'economic') : ''})`;
                pDiv.textContent = text;
                display.appendChild(pDiv);
            });
        }
        
        function clearCurrentDecadeProjects() {
            gameState.currentDecadeProjectDurations.forEach(item => {
                const actualEconomicCost = getAdjustedProjectCost(item.project, 'economic');
                 if (actualEconomicCost !== 0) {
                    gameState.capital.economic += actualEconomicCost; // Refund/reverse income
                }
            });

            gameState.currentDecadeProjectDurations = [];
            updateCharacterDisplay();
            renderProjects();
            renderTimelineSlots();
            updateCurrentProjectsListDisplay();
        }
        
        function applyProjectEffects(project, currentDecadeLogEntry) {
            let effectSummary = [];
            let lifeGoal = gameState.character.lifeGoal;
            let goalBonusMultiplier = 1 + (lifeGoalsData[lifeGoal]?.bonus_multiplier || 0); // e.g. 1.1 if 10% bonus

            if (project.benefits) {
                // Capital benefits
                if (project.benefits.capital) {
                    for (const type in project.benefits.capital) {
                        let benefitValue = project.benefits.capital[type];
                        if (lifeGoalsData[lifeGoal]?.bonus?.capital?.[type]) { // Check if goal gives bonus to this capital type
                            benefitValue *= (1 + lifeGoalsData[lifeGoal].bonus.capital[type]);
                        }
                        gameState.capital[type] = (gameState.capital[type] || 0) + benefitValue;
                        effectSummary.push(`${type}: ${benefitValue >= 0 ? '+' : ''}${Math.round(benefitValue)}`);
                    }
                }
                // Stats benefits
                if (project.benefits.stats) {
                    for (const type in project.benefits.stats) {
                        let benefitValue = project.benefits.stats[type];
                         if (lifeGoalsData[lifeGoal]?.bonus?.stats?.[type]) { // Check if goal gives bonus to this stat
                            benefitValue *= (1 + lifeGoalsData[lifeGoal].bonus.stats[type]);
                        }
                        gameState.stats[type] = (gameState.stats[type] || 0) + benefitValue;
                        effectSummary.push(`${type}: ${benefitValue >= 0 ? '+' : ''}${Math.round(benefitValue)}`);
                    }
                }
            }
            // Costs (effort time already "spent", economic cost at selection, other direct capital costs)
            if (project.costs) {
                for (const type in project.costs) {
                    if (type !== 'time' && type !== 'economic') { // time & economic handled elsewhere or conceptual
                        if (gameState.capital.hasOwnProperty(type)) {
                            gameState.capital[type] += project.costs[type]; // Can be negative
                            if(project.costs[type] !== 0) effectSummary.push(`${type}: ${project.costs[type]}`);
                        } else if (gameState.stats.hasOwnProperty(type)) {
                            gameState.stats[type] += project.costs[type];
                            if(project.costs[type] !== 0) effectSummary.push(`${type}: ${project.costs[type]}`);
                        }
                    }
                }
            }

            if (project.outcomes) {
                if (project.outcomes.constraints) {
                    for (const key in project.outcomes.constraints) {
                        gameState.constraints[key] = project.outcomes.constraints[key];
                        effectSummary.push(`Status: ${key} -> ${project.outcomes.constraints[key]}`);
                    }
                }
                if (project.outcomes.education_level) {
                    // Ensure education only progresses, doesn't regress
                    const eduHierarchy = ['ingen', 'grundskola', 'grundskola_avslutad', 'folkhögskola', 'gymnasium', 'yrkeshögskola', 'högskola_kandidat', 'högskola_master'];
                    if(eduHierarchy.indexOf(project.outcomes.education_level) > eduHierarchy.indexOf(gameState.constraints.education_level)){
                        gameState.constraints.education_level = project.outcomes.education_level;
                        effectSummary.push(`Utbildning: ${project.outcomes.education_level.replace("_", " ")}`);
                    }
                }
            }
            if(project.unique) {
                gameState.completedUniqueProjectIds.add(project.id);
            }
            gameState.allCompletedProjects.push({ name: project.name, decade: gameState.currentDecadeIndex });
            currentDecadeLogEntry.projects.push({ name: project.name, effects: effectSummary.join(', ') || "Inga direkta effekter." });
            return effectSummary.join(', ');
        }


        function completeDecade() {
            let reflectionHTML = `<h3>Sammanfattning för ${gameState.decades[gameState.currentDecadeIndex]} (Ålder ${gameState.age}-${gameState.age+9}):</h3>`;
            reflectionHTML += "<h4>Genomförda projekt:</h4><ul>";
            
            const currentDecadeLogEntry = gameState.decadeLog[gameState.currentDecadeIndex];

            if (gameState.currentDecadeProjectDurations.length === 0) {
                reflectionHTML += "<li>Inga större projekt planerades detta decennium.</li>";
            }

            gameState.currentDecadeProjectDurations.forEach(item => {
                const project = item.project;
                reflectionHTML += `<li><strong>${project.name}</strong>: `;
                const effectsString = applyProjectEffects(project, currentDecadeLogEntry);
                reflectionHTML += effectsString + "</li>";
            });
            reflectionHTML += "</ul>";

            const histData = historicalEventsData[gameState.currentDecadeIndex];
            if (histData && histData.modifiers) {
                reflectionHTML += "<h4>Påverkan från samhällsutvecklingen:</h4><ul>";
                const modifiers = histData.modifiers;
                if (modifiers.capital_growth) {
                    for(const capType in modifiers.capital_growth) {
                        let growth = Math.round((gameState.capital[capType]||0) * modifiers.capital_growth[capType]);
                        gameState.capital[capType] += growth;
                        reflectionHTML += `<li>Tillväxt ${capType}: ${growth >= 0 ? '+' : ''}${growth}.</li>`;
                    }
                }
                if (modifiers.capital_change) {
                     for(const capType in modifiers.capital_change) {
                        let change = Math.round((gameState.capital[capType]||0) * modifiers.capital_change[capType]);
                        // Special handling for functions as modifiers (e.g. social capital change in 2010s)
                        if(typeof modifiers.capital_change[capType] === 'function'){
                            change = Math.round(modifiers.capital_change[capType](gameState)); // Pass gameState if function needs it
                        } else {
                             change = Math.round((gameState.capital[capType]||0) * modifiers.capital_change[capType]);
                        }
                        gameState.capital[capType] += change;
                        reflectionHTML += `<li>Förändring ${capType}: ${change >= 0 ? '+' : ''}${change}.</li>`;
                    }
                }
                if (modifiers.general_optimism) {
                    let boost = Math.round(gameState.stats.happiness * modifiers.general_optimism);
                    gameState.stats.happiness += boost;
                     reflectionHTML += `<li>Allmän optimism: +${boost} lycka.</li>`;
                }
                // Add more specific historical modifiers here
                reflectionHTML += "</ul>";
            }


            document.getElementById('reflectionContent').innerHTML = reflectionHTML;
            
            const decadeEventsLog = currentDecadeLogEntry.events;
            const eventsListElement = document.querySelector("#decadeEvents ul");
            eventsListElement.innerHTML = ''; 
            if(decadeEventsLog && decadeEventsLog.length > 0){
                decadeEventsLog.forEach(event => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${event.title}:</strong> ${event.description} <em>(${event.effects})</em>`;
                    eventsListElement.appendChild(li);
                });
                document.getElementById("decadeEvents").style.display = 'block';
            } else {
                 document.getElementById("decadeEvents").style.display = 'none';
            }

            gameState.stats.health = Math.max(0, Math.min(100, gameState.stats.health));
            gameState.stats.happiness = Math.max(0, Math.min(100, gameState.stats.happiness));

            if (gameState.currentDecadeIndex >= gameState.decades.length -1) {
                document.getElementById('nextDecadeButton').innerText = "Se livssammanfattning";
            } else {
                 document.getElementById('nextDecadeButton').innerText = "Nästa decennium";
            }

            showScreen('reflectionScreen');
        }
        
        // --- RANDOM EVENTS ---
        function triggerRandomEvents() {
            const eventCategories = ['positive', 'negative', 'neutral'];
            let eventTriggeredThisDecade = false; // Could be used to limit # of events

            for (const category of eventCategories) {
                for (const event of randomEventTypes[category]) {
                    let probability = event.probability;

                    if (event.class_modifier && gameState.character.socialClass in event.class_modifier) {
                        probability *= event.class_modifier[gameState.character.socialClass];
                    }
                    if (event.decade_modifier && gameState.currentDecadeIndex in event.decade_modifier) {
                        probability *= event.decade_modifier[gameState.currentDecadeIndex];
                    }
                    probability *= gameState.character.opportunitiesModifier;
                    
                    // Life goal can influence event probability
                    if(gameState.character.lifeGoal && event.life_goal_modifier?.[gameState.character.lifeGoal]){
                        probability *= event.life_goal_modifier[gameState.character.lifeGoal];
                    }


                    if (Math.random() < probability) {
                        let canTrigger = true;
                        if (event.requirements) {
                            if (event.requirements.capital_min) {
                                for (const cap_type in event.requirements.capital_min) {
                                    if ((gameState.capital[cap_type]||0) < event.requirements.capital_min[cap_type]) canTrigger = false;
                                }
                            }
                            if (event.requirements.constraints_is) {
                                for (const key in event.requirements.constraints_is) {
                                    if (gameState.constraints[key] !== event.requirements.constraints_is[key]) canTrigger = false;
                                }
                            }
                             if (event.requirements.constraints_any) { 
                                let metAnyConstraint = false;
                                for (const key in event.requirements.constraints_any) {
                                    const requiredValues = Array.isArray(event.requirements.constraints_any[key]) ? event.requirements.constraints_any[key] : [event.requirements.constraints_any[key]];
                                    if (requiredValues.includes(gameState.constraints[key])) {
                                        metAnyConstraint = true;
                                        break;
                                    }
                                }
                                if (!metAnyConstraint) canTrigger = false;
                            }
                        }

                        if (canTrigger) {
                            applyRandomEventEffect(event); // Renamed function
                            showModal('randomEventModal', `Slumpmässig händelse: ${event.title}`, event.description);
                            eventTriggeredThisDecade = true; 
                        }
                    }
                }
            }
        }

        function applyRandomEventEffect(event) { // Renamed
            let effectSummary = [];
            let lifeGoal = gameState.character.lifeGoal;

            if (event.effects.capital) {
                for (const type in event.effects.capital) {
                    let value = event.effects.capital[type];
                    if(lifeGoalsData[lifeGoal]?.bonus?.capital?.[type] && value > 0){ // Bonus only on positive gains
                        value *= (1 + lifeGoalsData[lifeGoal].bonus.capital[type]);
                    }
                    gameState.capital[type] = (gameState.capital[type] || 0) + value;
                    effectSummary.push(`${type}: ${value >= 0 ? '+' : ''}${Math.round(value)}`);
                }
            }
            if (event.effects.stats) {
                for (const type in event.effects.stats) {
                     let value = event.effects.stats[type];
                    if(lifeGoalsData[lifeGoal]?.bonus?.stats?.[type] && value > 0){
                        value *= (1 + lifeGoalsData[lifeGoal].bonus.stats[type]);
                    }
                    gameState.stats[type] = (gameState.stats[type] || 0) + value;
                    effectSummary.push(`${type}: ${value >= 0 ? '+' : ''}${Math.round(value)}`);
                }
            }
            if (event.effects.outcomes && event.effects.outcomes.constraints) { 
                for (const type in event.effects.outcomes.constraints) {
                    gameState.constraints[type] = event.effects.outcomes.constraints[type];
                    effectSummary.push(`Ny status: ${type} -> ${event.effects.outcomes.constraints[type]}`);
                }
            }
            
            if(!gameState.decadeLog[gameState.currentDecadeIndex]) gameState.decadeLog[gameState.currentDecadeIndex] = {projects: [], events: []};
            gameState.decadeLog[gameState.currentDecadeIndex].events.push({
                title: event.title,
                description: event.description,
                effects: effectSummary.join(', ') || "Inga direkta effekter."
            });
            updateCharacterDisplay(); 
        }

        // --- FINAL SUMMARY ---
        function showFinalSummary() {
            const summaryDiv = document.getElementById('lifeSummary');
            summaryDiv.innerHTML = ''; 

            let finalCapitalHTML = `<h4>Slutligt Kapital:</h4><div class="character-stats">`;
            for (const [key, value] of Object.entries(gameState.capital)) {
                finalCapitalHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${Math.round(value)}</div>`;
            }
            finalCapitalHTML += `</div>`;
            
            let finalStatsHTML = `<h4>Slutlig Livskvalitet:</h4><div class="character-stats">`;
             for (const [key, value] of Object.entries(gameState.stats)) {
                finalStatsHTML += `<div class="stat-item"><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${Math.round(value)}</div>`;
            }
            finalStatsHTML += `</div>`;
            document.getElementById('finalStats').innerHTML = `${finalCapitalHTML}${finalStatsHTML}`;

            const projectsCard = document.createElement('div');
            projectsCard.className = 'summary-card';
            let projectsHTML = '<h4>Genomförda Livsprojekt:</h4><ul>';
            const projectsByDecade = {};
            gameState.allCompletedProjects.forEach(p => {
                if(!projectsByDecade[p.decade]) projectsByDecade[p.decade] = [];
                projectsByDecade[p.decade].push(p.name);
            });
            for(let i = 0; i < gameState.decades.length; i++){
                if(projectsByDecade[i] && projectsByDecade[i].length > 0){
                    projectsHTML += `<li><strong>${gameState.decades[i]}:</strong><ul>`;
                    projectsByDecade[i].forEach(name => projectsHTML += `<li>${name}</li>`);
                    projectsHTML += `</ul></li>`;
                }
            }
            if (gameState.allCompletedProjects.length === 0) projectsHTML += '<li>Inga större projekt registrerade.</li>';
            projectsHTML += '</ul>';
            projectsCard.innerHTML = projectsHTML;
            summaryDiv.appendChild(projectsCard);

            const eventsCard = document.createElement('div');
            eventsCard.className = 'summary-card';
            let eventsHTML = '<h4>Noterbara Händelser Genom Åren:</h4><ul>';
            let hadEvents = false;
            gameState.decadeLog.forEach((log, index) => {
                if (log.events.length > 0) {
                    hadEvents = true;
                    eventsHTML += `<li><strong>${gameState.decades[index]}:</strong><ul>`;
                    log.events.forEach(event => {
                        eventsHTML += `<li>${event.title} <em>(${event.effects})</em></li>`;
                    });
                    eventsHTML += `</ul></li>`;
                }
            });
            if (!hadEvents) eventsHTML += '<li>Inga speciella slumpmässiga händelser registrerade.</li>';
            eventsHTML += '</ul>';
            eventsCard.innerHTML = eventsHTML;
            summaryDiv.appendChild(eventsCard);
            
            // Life Goal Reflection
            const lifeGoalCard = document.getElementById('lifeGoalReflection');
            const chosenGoalKey = gameState.character.lifeGoal;
            const chosenGoalInfo = lifeGoalsData[chosenGoalKey];
            let goalReflectionText = `<h4>Reflektion över ditt livsmål: "${chosenGoalInfo.name}"</h4>`;
            let score = 0; // Simple scoring for goal
            let explanation = "";

            switch(chosenGoalKey) {
                case 'happiness': score = gameState.stats.happiness; explanation = `Din slutliga lycka blev ${Math.round(score)}/100.`; break;
                case 'wealth': score = gameState.capital.economic; explanation = `Ditt slutliga ekonomiska kapital blev ${Math.round(score)}.`; break;
                case 'family': score = gameState.capital.social + (gameState.constraints.hasChildren ? 20 : 0) + (gameState.constraints.isMarried ? 10 : 0); explanation = `Du byggde relationer och familjeband (Socialt kapital: ${Math.round(gameState.capital.social)}, Barn: ${gameState.constraints.hasChildren ? 'Ja':'Nej'}, Gift/Sambo: ${gameState.constraints.isMarried ? 'Ja':'Nej'}).`; break;
                case 'knowledge': score = gameState.capital.cultural; explanation = `Ditt slutliga kulturella kapital blev ${Math.round(score)}. Din högsta utbildning var ${gameState.constraints.education_level.replace("_", " ")}.`; break;
                case 'status': score = gameState.capital.symbolic; explanation = `Ditt slutliga symboliska kapital (anseende) blev ${Math.round(score)}.`; break;
            }
            goalReflectionText += `<p>${explanation}</p><p>Detta speglar hur väl dina val överensstämde med din strävan att ${chosenGoalInfo.description.toLowerCase().substring(0, chosenGoalInfo.description.length-1)}.</p>`;
            lifeGoalCard.innerHTML = goalReflectionText;
            lifeGoalCard.style.display = 'block';


            showScreen('summaryScreen');
        }

        // Initial call to show intro
        showScreen('introScreen');

    </script>
</body>
</html>
